<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice4U тАУ Brave Buddy Chatbot</title>
  <style>
    body {
      margin:0; font-family:Arial,sans-serif; height:100vh;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(270deg,#ff6ec4,#7873f5,#4ade80,#facc15,#f87171);
      background-size:1000% 1000%; animation:rainbow 15s ease infinite;
    }
    @keyframes rainbow {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
.controls .btn,
#voiceSelect {
  color: black !important;
  background: #FFD700;   /* yellow background */
  font-weight: bold;
}

#langToggle {
  color: black !important;
  background: linear-gradient(135deg, #fcd34d, #fbbf24); /* optional: a warm gradient */
  font-weight: bold;
}

    .wrap { width:95%; max-width:900px; }
    .app { background: url('texture.jpg'); /* local image folder 'images' */ 
      background-size: cover;
      background-repeat: no-repeat;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      position: relative;
    }
    .heading { text-align: center;
      font-size: 34px;
      font-weight: bold;
      margin-bottom: 20px;
      background: linear-gradient(90deg, #ff0080, #7928ca, #2afadf);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: glow 3s infinite alternate;}
    @keyframes glow {
      0% { text-shadow:0 0 10px #ff0080,0 0 20px #ff0080; }
      100%{ text-shadow:0 0 25px #2afadf,0 0 40px #7928ca; }
    }
    .mascot { background-color: transparent; position:absolute; top:150px; right:10px; width:200px; height:200px;
      border-radius:0; cursor:pointer; transition:all 2s ease;}
    .angry {
      filter: hue-rotate(-50deg) saturate(5); /* turns reddish */
      animation: shake 0.3s infinite;
    }
    @keyframes shake {
      0% { transform: translate(0px, 0px) rotate(0deg); }
      20% { transform: translate(-5px, 0px) rotate(-2deg); }
      40% { transform: translate(5px, 0px) rotate(2deg); }
      60% { transform: translate(-5px, 0px) rotate(-2deg); }
      80% { transform: translate(5px, 0px) rotate(2deg); }
      100% { transform: translate(0px, 0px) rotate(0deg); }
    }
    .controls { display:flex; gap:10px; margin-bottom:10px;}
    .chat { height:350px; overflow-y:auto; margin-bottom:12px; background:rgba(255,255,255,0.5); border-radius:14px; padding:10px;}
    .msg { margin:6px 0;}
    .msg.user .bubble { background:#4ade80;color:white;border-radius:16px;padding:8px 12px;display:inline-block;}
    .msg.bot .bubble { background:#fff;border:1px solid #ddd;border-radius:16px;padding:8px 12px;display:inline-block;}
    .menu { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px;}
    .card { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);; border-radius:12px; padding:10px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
    .btn { padding:10px 16px; border:none; border-radius:12px; background:linear-gradient(135deg,#6366f1,#8b5cf6); color:white; font-weight:bold; cursor:pointer; transition:0.3s;}
    .btn:hover { transform:scale(1.08); background:linear-gradient(135deg,#8b5cf6,#6366f1); }
    .back-btn { margin-top:10px; background:linear-gradient(135deg,#10b981,#22d3ee); color:white; padding:10px; border:none; border-radius:12px; cursor:pointer; display:block; width:100%; font-weight:bold;}
    .quiz-options { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .quiz-options button { margin:4px; display:block; width:100%; transition:all 0.3s ease; }
    img.answer-img {
      width:250px;
      display: block;
      margin:10px auto;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.25);
    }
    .pledge-text { margin:12px 0; font-size:18px; font-weight:500; }
    .pledge-text span { color:black; transition:color 0.2s ease; }
    .pledge-text span.active { color:red; font-weight:bold; }
    textarea#input { width: calc(100% - 120px); height:48px; padding:8px; border-radius:8px; border:1px solid #ddd; resize:none; }
    form#composer { display:flex; gap:8px; align-items:center; }
    button[type="submit"] { min-width:110px; height:48px; }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="app">
      <div class="heading">ЁЯМЯ Brave Buddy тАУ For You ЁЯМЯ</div>
      <img src="images/bulb_default.png" class="mascot" id="mascot" alt="Mascot">

      <div class="controls">
        <button id="langToggle" class="btn">ЁЯМР Language: English</button>
        <button id="voiceBtn" class="btn" onclick="toggleVoice();playClick()">ЁЯФК Voice ON</button>
        <button id="micBtn" class="btn">ЁЯОд Speak</button>
        <select id="voiceSelect" class="btn"></select>
      </div>
      <audio id="bgMusic" src="meditation.mp3" autoplay loop></audio>
      <audio id="clickSound" src="chime.mp3" preload="auto"></audio>
      <audio id="clapSound" src="clap.mp3" preload="auto"></audio>
      <section id="chat" class="chat" role="log" aria-live="polite"></section>
      <form id="composer" autocomplete="off">
        <textarea id="input" placeholder="Type here..."></textarea>
        <button class="btn" type="submit">Send тЦ╢</button>
      </form>
    </main>
  </div>

<script>
window.onload = () => {
  const app = document.querySelector(".app");
  const x = app.clientWidth - mascot.clientWidth - 20;
  mascot.style.left = x + "px";
  mascot.style.top = "150px";
  bounceMascotVertical();
  // start human verification prompt
  askHumanVerification();

  // ЁЯО╡ Background music setup
  const bgMusic = document.getElementById("bgMusic");
  bgMusic.volume = 0.1; // soft volume (0.0 тАУ silent, 1.0 тАУ max)
  bgMusic.playbackRate = 0.1;
};
document.body.addEventListener("click", () => {
  if (bgMusic.paused) {
    bgMusic.muted = false;
    bgMusic.play().then(() => {
      bgMusic.volume = 0.1;       // soft
      bgMusic.playbackRate = 0.7; // slow
    }).catch(err => console.log("Music blocked:", err));
  }
}, { once: true });

/* ----------------- Elements ----------------- */
const chat=document.getElementById("chat");
const mascot=document.getElementById("mascot");
const langToggle=document.getElementById("langToggle");
const micBtn=document.getElementById("micBtn");

/* ----------------- Settings & State ----------------- */
let language="en";
let voiceEnabled=true;
let voiceRate = 0.9;
let state = {
  awaitingName:true,
  userName:null,
  awaitingRoleplay:false,
  awaitingQuiz:false,
  quizIndex:0,
  quizScore:0,
  awaitingPledge:false,
  awaitingBullyingCategory:false,
  awaitingBullyingType:false,
  bullyingPersona:null,
  // Human verification fields
  awaitingCode:true,
  secretCode:null,
  codeAttempts:0,
  maxCodeAttempts:3
};

/* ----------------- Voice output ----------------- */
function toggleVoice() {
  voiceEnabled = !voiceEnabled;
  const btn = document.getElementById("voiceBtn");
  btn.innerText = voiceEnabled ? "ЁЯФК Voice ON" : "ЁЯФЗ Voice OFF";

  // Stop any current speech immediately when OFF
  if (!voiceEnabled) {
    speechSynthesis.cancel();
  }
}

let selectedVoice = null;

function speak(text, mood="normal") {
  if (!voiceEnabled) return;
  if (/prove you are human/i.test(text) || /new number/i.test(text) || /рдирдИ рд╕рдВрдЦреНрдпрд╛/i.test(text)) return;

  // ЁЯз╣ Clean text: remove emojis & symbols
  let cleaned = text.replace(/<[^>]*>/g, "");       // remove HTML tags
  cleaned = cleaned.replace(/[^\p{L}\p{N}\s.,!?'"-]/gu, ""); // keep only letters, numbers, punctuation
  cleaned = cleaned.replace(/\s+/g, " ").trim();   // collapse spaces
  if (!cleaned) return;

  const utter = new SpeechSynthesisUtterance(cleaned);
  const voices = speechSynthesis.getVoices();

  if (selectedVoice) {
    utter.voice = voices.find(v => v.name === selectedVoice) || null;
    if (utter.voice) utter.lang = utter.voice.lang;
  } else {
    utter.lang = "en-IN"; // fallback
  }

  // ЁЯОн moods
  switch(mood){
    case "happy": utter.rate=1.1; utter.pitch=1.3; break;
    case "serious": utter.rate=0.9; utter.pitch=0.8; break;
    case "calm": utter.rate=0.7; utter.pitch=1; break;
    default: utter.rate=1; utter.pitch=1;
  }

  speechSynthesis.speak(utter);
}
micBtn.onclick = () => {
  if (recognition) {
    recognition.lang = (language === "en") ? "en-US" : "hi-IN";
    recognition.start();
    addMessage("bot", (language==="en") ? "ЁЯОд Listening..." : "ЁЯОд рд╕реБрди рд░рд╣рд╛ рд╣реВрдБ...", true); // silent so it doesnтАЩt speak
  } else {
    addMessage("bot", (language==="en") 
      ? "тЪая╕П Speech recognition not supported in this browser." 
      : "тЪая╕П рдпрд╣ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рд╡реЙрдЗрд╕ рд░рд┐рдХрдЧреНрдирд┐рд╢рди рд╕рдкреЛрд░реНрдЯ рдирд╣реАрдВ рдХрд░рддрд╛ред");
  }
};

/* ----------------- Mascot & Moods ----------------- */
function populateVoiceList() {
  const voiceSelect = document.getElementById("voiceSelect");
  const voices = speechSynthesis.getVoices();

  voiceSelect.innerHTML = "";
  voices.forEach(v => {
    const option = document.createElement("option");
    option.value = v.name;
    option.textContent = `${v.name} (${v.lang})`;
    voiceSelect.appendChild(option);
  });

  // ЁЯСЗ Try to set Microsoft Prabhat (India) as default
  const prabhat = voices.find(v => v.name.toLowerCase().includes("prabhat"));
  if (prabhat) {
    voiceSelect.value = prabhat.name;
    selectedVoice = prabhat.name;
  } else {
    // fallback: Indian English if available
    const indian = voices.find(v => v.lang === "en-IN");
    if (indian) {
      voiceSelect.value = indian.name;
      selectedVoice = indian.name;
    } else {
      // fallback to first voice
      selectedVoice = voices[0]?.name || null;
    }
  }
}
speechSynthesis.onvoiceschanged = populateVoiceList;

document.getElementById("voiceSelect").addEventListener("change", e => {
  selectedVoice = e.target.value;
});

function setMascotMood(mood){ mascot.src="images/"+mood+".png"; }
function playClap() {
  const clap = document.getElementById("clapSound");
  if (clap) { clap.currentTime = 0; clap.play(); }
}

/* ----------------- Chat UI helpers ----------------- */
function addMessage(role, text, silent=false, mood="normal"){
  const row=document.createElement("div");
  row.className="msg "+role;
  const bubble=document.createElement("div");
  bubble.className="bubble"; 
  bubble.innerHTML=text;
  row.appendChild(bubble);
  chat.appendChild(row);
  autoScroll();
  
  if(role==="bot" && !silent) speak(text, mood);
}
function addImage(src){
  const img=document.createElement("img");
  img.src="images/"+src;
  img.className="answer-img";
  chat.appendChild(img);
  autoScroll();
}
function autoScroll() {
  requestAnimationFrame(() => {
    chat.scrollTo({ top: chat.scrollHeight, behavior: "smooth" });
  });
}

/* ----------------- Texts ----------------- */
const texts = {
  en:{
    intro:"ЁЯСЛ LetтАЩs introduce each other! First tell me your name. I am your Brave Buddy to give awareness on bullying.",
    nice:"Nice to meet you,",
    bullying:"Bullying = repeated harm with imbalance of power.",
    advice:"If you are being bullied Stay calm, walk away, save evidence, tell an adult.If you want to give advice to a friend who is bullying someone is a sensitive situation and plan the conversation carefully by choosing the right time and place, set a positive tone, explain the consequences of bullying and be specific.",
    report:"Save proof, block/report, tell a teacher/parent.For any immediate threat or danger related to bullying always call your country's universal emergency number 112 (Emergency Response Support System-ERSS), Childline 1098 is a 24-hour, free, national emergency phone service. For women facing violence or harassment, including in workplace, The National Commission for Women has a helpline at 7827170170",
   role:"ЁЯОн Let's practice! I'll give you different bullying situations.",
    quizIntro:"ЁЯУЭ LetтАЩs start the quiz!",
    pledge:"I pledge to stand against bullying and spread kindness.",
    closing:"ЁЯМЯ Thank you! You are a Brave Buddy!",
    back:"тмЕ Back to Menu"
  },
  hi:{
    intro:"ЁЯСЛ рдЪрд▓реЛ рдПрдХ-рджреВрд╕рд░реЗ рд╕реЗ рдкрд░рд┐рдЪрдп рдХрд░реЗрдВ! рдкрд╣рд▓реЗ рдЕрдкрдирд╛ рдирд╛рдо рдмрддрд╛рдЗрдПред рдореИрдВ рдЖрдкрдХрд╛ рдмреНрд░реЗрд╡ рдмрдбреА рд╣реВрдБ рдЬреЛ рдмрджрдорд╛рд╢реА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдЧрд░реВрдХрддрд╛ рджреЗрддрд╛ рд╣реИред",
    nice:"рдЖрдкрд╕реЗ рдорд┐рд▓рдХрд░ рдЦреБрд╢реА рд╣реБрдИ,",
    bullying:"рдмрджрдорд╛рд╢реА = рдмрд╛рд░-рдмрд╛рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдиреБрдХрд╕рд╛рди рдЬрд┐рд╕рдореЗрдВ рд╢рдХреНрддрд┐ рдХрд╛ рдЕрд╕рдВрддреБрд▓рди рд╣реЛред",
    advice:"рд╢рд╛рдВрдд рд░рд╣реЗрдВ, рджреВрд░ рдЪрд▓реЗ рдЬрд╛рдПрдБ, рд╕рдмреВрдд рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦреЗрдВ рдФрд░ рдХрд┐рд╕реА рдмрдбрд╝реЗ рдХреЛ рдмрддрд╛рдПрдВред",
    report:"рд╕рдмреВрдд рд░рдЦреЗрдВ, рдмреНрд▓реЙрдХ/рд░рд┐рдкреЛрд░реНрдЯ рдХрд░реЗрдВ рдФрд░ рд╢рд┐рдХреНрд╖рдХ рдпрд╛ рдорд╛рддрд╛-рдкрд┐рддрд╛ рдХреЛ рдмрддрд╛рдПрдВред",
   role:"ЁЯОн рдЪрд▓реЛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ! рдореИрдВ рдЖрдкрдХреЛ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдмрджрдорд╛рд╢реА рдХреА рд╕реНрдерд┐рддрд┐рдпрд╛рдБ рджреВрдБрдЧрд╛ред",
    quizIntro:"ЁЯУЭ рдЪрд▓реЛ рдХреНрд╡рд┐рдЬрд╝ рд╢реБрд░реВ рдХрд░реЗрдВ!",
    pledge:"рдореИрдВ рдмрджрдорд╛рд╢реА рдХреЗ рдЦрд┐рд▓рд╛рдл рдЦрдбрд╝рд╛ рд░рд╣реВрдБрдЧрд╛ рдФрд░ рджрдпрд╛ рдлреИрд▓рд╛рдКрдБрдЧрд╛ред",
    closing:"ЁЯМЯ рдзрдиреНрдпрд╡рд╛рдж! рдЖрдк рдмрджрдорд╛рд╢реА рдХреЗ рдЦрд┐рд▓рд╛рдл рдПрдХ рдмреНрд░реЗрд╡ рдмрдбреА рд╣реИрдВ!",
    back:"тмЕ рдореЗрдиреНрдпреВ рдкрд░ рд╡рд╛рдкрд╕ рдЬрд╛рдПрдБ"
  }
};
const roleplayScenarios = {
  en: [
    "Someone says: 'YouтАЩre not good enough.' тАУ What do you reply?",
    "Someone pushes you in the corridor. What do you say?",
    "A classmate posts a mean comment about you online. How will you respond?",
    "A friend keeps excluding you from group activities. What would you do?"
  ],
  hi: [
    "рдХреЛрдИ рдХрд╣рддрд╛ рд╣реИ: 'рддреБрдо рдЕрдЪреНрдЫреЗ рдирд╣реАрдВ рд╣реЛред' тАУ рдЖрдк рдХреНрдпрд╛ рдЬрд╡рд╛рдм рджреЗрдВрдЧреЗ?",
    "рдХреЛрдИ рдЖрдкрдХреЛ рдЧрд▓рд┐рдпрд╛рд░реЗ рдореЗрдВ рдзрдХреНрдХрд╛ рджреЗрддрд╛ рд╣реИред рдЖрдк рдХреНрдпрд╛ рдХрд╣реЗрдВрдЧреЗ?",
    "рдПрдХ рд╕рд╣рдкрд╛рдареА рдЖрдкрдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдСрдирд▓рд╛рдЗрди рдмреБрд░рд╛ рдХрдореЗрдВрдЯ рдХрд░рддрд╛ рд╣реИред рдЖрдк рдХреИрд╕реЗ рдЬрд╡рд╛рдм рджреЗрдВрдЧреЗ?",
    "рдПрдХ рджреЛрд╕реНрдд рдмрд╛рд░-рдмрд╛рд░ рдЖрдкрдХреЛ рд╕рдореВрд╣ рдЧрддрд┐рд╡рд┐рдзрд┐рдпреЛрдВ рд╕реЗ рдмрд╛рд╣рд░ рдХрд░рддрд╛ рд╣реИред рдЖрдк рдХреНрдпрд╛ рдХрд░реЗрдВрдЧреЗ?"
  ]
};

/* ----------------- Language toggle ----------------- */
langToggle.onclick=()=>{
  language=(language==="en")?"hi":"en";
  langToggle.textContent=(language==="en")?"ЁЯМР Language: English":"ЁЯМР рднрд╛рд╖рд╛: рд╣рд┐рдВрджреА";
  // when language changes, if human verification still pending, show refreshed prompt
  if(state.awaitingCode){
    askHumanVerification(true); // refresh message only
  } else {
    showMenu();
  }
};

/* ----------------- Choice buttons helper ----------------- */
function contactFriend(){
  setMascotMood("bulb_happy");
  addMessage("bot",(language==="en")
    ? "ЁЯУ▒ Please enter your friendтАЩs WhatsApp number (with country code):"
    : "ЁЯУ▒ рдХреГрдкрдпрд╛ рдЕрдкрдиреЗ рдорд┐рддреНрд░ рдХрд╛ рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рдирдВрдмрд░ рд▓рд┐рдЦреЗрдВ (рджреЗрд╢ рдХреЛрдб рд╕рд╣рд┐рдд):");

  const div=document.createElement("div");
  div.className="temp-ui";
  div.innerHTML=`
    <input id="friendNumber" placeholder="${language==="en"?"Enter number":"рдирдВрдмрд░ рджрд░реНрдЬ рдХрд░реЗрдВ"}" 
           style="width:100%;margin:6px 0;padding:6px;">
    <button class="btn" id="sendWhatsApp">${language==="en"?"ЁЯУй Contact on WhatsApp":"ЁЯУй рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рдкрд░ рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдВ"}</button>
  `;
  chat.appendChild(div);

  document.getElementById("sendWhatsApp").onclick=()=>{
    const num=document.getElementById("friendNumber").value.trim();
    if(!/^\d{10,15}$/.test(num)){
      addMessage("bot",(language==="en")?"тЪая╕П Please enter a valid number with country code.":"тЪая╕П рдХреГрдкрдпрд╛ рд╕рд╣реА рдирдВрдмрд░ рдбрд╛рд▓реЗрдВ (рджреЗрд╢ рдХреЛрдб рд╕рд╣рд┐рдд)ред");
      return;
    }

    const msg=(language==="en")
      ? "Hi, I need your help. I am facing bullying."
      : "рдирдорд╕реНрддреЗ, рдореБрдЭреЗ рдЖрдкрдХреА рдорджрдж рдЪрд╛рд╣рд┐рдПред рдореИрдВ рдмрджрдорд╛рд╢реА рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░ рд░рд╣рд╛ рд╣реВрдБред";

    // WhatsApp link
    const link=`https://wa.me/${num}?text=${encodeURIComponent(msg)}`;
    window.open(link,"_blank");  // opens WhatsApp Web / App
  };

  addBack();
}

function emergencyHelp(){
  setMascotMood("bulb_serious");
  addMessage("bot",(language==="en")
    ? "ЁЯУЮ If you are in danger or need urgent help, you can call these helplines directly:"
    : "ЁЯУЮ рдпрджрд┐ рдЖрдк рдЦрддрд░реЗ рдореЗрдВ рд╣реИрдВ рдпрд╛ рддреБрд░рдВрдд рдорджрдж рдЪрд╛рд╣рд┐рдП, рддреЛ рдЖрдк рдЗрди рд╣реЗрд▓реНрдкрд▓рд╛рдЗрди рдкрд░ рдХреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:");

  const helpDiv = document.createElement("div");
  helpDiv.className = "temp-ui";

  helpDiv.innerHTML = `
    <button class="btn" onclick="window.location.href='tel:112'">ЁЯЪи Call Police  (Emergency)</button>
    <button class="btn" onclick="window.location.href='tel:1098'">ЁЯС╢ Call 1098 (Childline)</button>
    <button class="btn" onclick="window.location.href='tel:7827170170'">ЁЯСй Call NCW 7827170170</button>
  `;

  chat.appendChild(helpDiv);
  autoScroll();
  addBack();
}

function addChoiceButtons(labels, onChoose){
  // remove any existing temp-ui
  document.querySelectorAll(".temp-ui").forEach(x=>x.remove());
  const box=document.createElement("div");
  box.className="quiz-options temp-ui";
  labels.forEach(l=>{
    const b=document.createElement("button");
    b.className="btn";
    b.textContent=l;
    b.onclick=(e)=>{ e.preventDefault(); onChoose(l); box.querySelectorAll("button").forEach(bb=>bb.disabled=true); };
    box.appendChild(b);
  });
  chat.appendChild(box); autoScroll();
}

/* ----------------- Menu & Navigation ----------------- */
function showMenu(){
  // remove previous temporary UIs
  chat.querySelectorAll(".menu,.back-btn,.temp-ui").forEach(o=>o.remove());
  const c=document.createElement("div"); 
  c.className="menu";

  const cards=[
    {t:(language==="en"?"ЁЯзШ Calm Down Mode":"ЁЯзШ рд╢рд╛рдВрдд рд░рд╣рдиреЗ рдХрд╛ рддрд░реАрдХрд╛"), h:()=>calmDown()},   // тЬЕ moved to first
    {t:(language==="en"?"ЁЯдФ Is it Bullying?":"ЁЯдФ рдХреНрдпрд╛ рдпрд╣ рдмрджрдорд╛рд╢реА рд╣реИ?"), h:()=>detectBullying()},
    {t:(language==="en"?"Tell me your situation":"рдЕрдкрдиреА рд╕реНрдерд┐рддрд┐ рдмрддрд╛рдЗрдП"), h:()=>explainBullying()},
    {t:(language==="en"?"Advice":"рд╕рд▓рд╛рд╣"), h:()=>giveAdvice()},
    {t:(language==="en"?"Report bullying":"рдмрджрдорд╛рд╢реА рдХреА рд░рд┐рдкреЛрд░реНрдЯ"), h:()=>reportBullying()},
    {t:(language==="en"?"Practice replies":"рдЬрд╡рд╛рдм рдЕрднреНрдпрд╛рд╕"), h:()=>startRoleplay()},
    {t:(language==="en"?"Quick quiz":"рдХреНрд╡рд┐рдЬрд╝"), h:()=>startQuiz()},
    {t:(language==="en"?"ЁЯУН Share Location":"ЁЯУН рд╕реНрдерд╛рди рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ"), h:()=>askLocation()},
    {t:(language==="en"?"ЁЯУЭ Report Bullying Form":"ЁЯУЭ рдмрджрдорд╛рд╢реА рд░рд┐рдкреЛрд░реНрдЯ рдлреЙрд░реНрдо"), h:()=>reportForm()},
    {t:(language==="en"?"ЁЯЪи Emergency Help":"ЁЯЪи рдЖрдкрд╛рддрдХрд╛рд▓реАрди рдорджрдж"), h:()=>emergencyHelp()},
    {t:(language==="en"?"ЁЯУ▒ Contact Friend on WhatsApp":"ЁЯУ▒ рдорд┐рддреНрд░ рд╕реЗ рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рдкрд░ рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдВ"), h:()=>contactFriend()},
    {t:(language==="en"?"Closing / Pledge":"рд╕рдорд╛рдкрди / рд╢рдкрде"), h:()=>pledge()}
  ];

  cards.forEach(({t,h})=>{
    const card=document.createElement("div"); 
    card.className="card";
    card.innerHTML=`<h4>${t}</h4>`;
    const btn=document.createElement("button"); 
    btn.className="btn"; 
    btn.textContent="Open тЦ╢"; 
    btn.onclick=(e)=>{ e.preventDefault(); h(); };
    card.appendChild(btn); 
    c.appendChild(card);
  });

  chat.appendChild(c); 
  autoScroll();
}
async function calmDown(){
  setMascotMood("bulb_thinking");
  await speak((language==="en")
    ? "ЁЯзШIt looks like you're feeling uneasy at the moment, Let's do a short breathing exercise. Follow my voice: InhaleтАж HoldтАж ExhaleтАж"
    : "ЁЯзШ рдЪрд▓реЛ рдПрдХ рдЫреЛрдЯрд╛ рд╢реНрд╡рд╛рд╕ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВред рдореЗрд░реА рдЖрд╡рд╛рдЬрд╝ рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ: рд╢реНрд╡рд╛рд╕ рд▓реЛтАж рд░реЛрдХреЛтАж рдЫреЛрдбрд╝реЛтАж"
  );

  const canvas=document.createElement("div");
  canvas.className="temp-ui";
  canvas.style.width="100%";
  canvas.style.height="200px";
  canvas.style.display="flex";
  canvas.style.alignItems="center";
  canvas.style.justifyContent="center";
  chat.appendChild(canvas);

  // Heart shape
const heart=document.createElement("div");
heart.style.position="relative";
heart.style.width="100px";
heart.style.height="90px";
heart.style.background="red";
heart.style.transform="rotate(-45deg) scale(1)";
heart.style.margin="20px";
heart.style.transition="all 4s ease-in-out";
heart.style.boxShadow="0 0 25px rgba(255,0,0,0.6), 0 0 50px rgba(255,0,0,0.4)";
canvas.appendChild(heart);

// Top left circle
const before=document.createElement("div");
before.style.content="''";
before.style.position="absolute";
before.style.width="100px";
before.style.height="100px";
before.style.borderRadius="50%";
before.style.background="red";
before.style.top="-50px";
before.style.left="0";
heart.appendChild(before);

// Top right circle
const after=document.createElement("div");
after.style.content="''";
after.style.position="absolute";
after.style.width="100px";
after.style.height="100px";
after.style.borderRadius="50%";
after.style.background="red";
after.style.left="50px";
after.style.top="0";
heart.appendChild(after);

let step=0;
async function breathe(){
  if(step%2===0){
    // Inhale - grow heart
    heart.style.transform="rotate(-45deg) scale(0.9)";
    heart.style.boxShadow="0 0 40px rgba(255,0,0,0.5), 0 0 80px rgba(255,0,0,0.3)";
    await speak((language==="en")?"ЁЯМмя╕П Inhale":"ЁЯМмя╕П рд╢реНрд╡рд╛рд╕ рд▓реЛ");
  } else {
    // Exhale - shrink heart
    heart.style.transform="rotate(-45deg) scale(1.4)";
    heart.style.boxShadow="0 0 15px rgba(255,0,0,0.8), 0 0 30px rgba(255,0,0,0.6)";
    await speak((language==="en")?"ЁЯШМ Exhale":"ЁЯШМ рд╢реНрд╡рд╛рд╕ рдЫреЛрдбрд╝реЛ");
  }
  step++;
  if(step<6){ 
    setTimeout(breathe, 5000); 
  } else {
    await speak((language==="en")?"тЬи Well done!":"тЬи рдмрд╣реБрдд рдЕрдЪреНрдЫрд╛!");
    addBack();
  }
}

  breathe();
autoScroll();
}
function detectBullying(){
  setMascotMood("bulb_thinking");
  state.awaitingBullyingDetect = true;
  
  addMessage("bot",(language==="en")
    ? "ЁЯУЭ Please describe the situation. IтАЩll try to tell you if it looks like bullying."
    : "ЁЯУЭ рдХреГрдкрдпрд╛ рд╕реНрдерд┐рддрд┐ рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдВред рдореИрдВ рдмрддрд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реВрдБрдЧрд╛ рдХрд┐ рдпрд╣ рдмрджрдорд╛рд╢реА рд╣реИ рдпрд╛ рдирд╣реАрдВред");

  addBack();
}
function askLocation(){
  setMascotMood("bulb_thinking");
  addMessage("bot",(language==="en")
    ? "ЁЯУН Trying to detect your locationтАж please allow location access in your browser."
    : "ЁЯУН рдЖрдкрдХрд╛ рд╕реНрдерд╛рди рдкрддрд╛ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣рд╛ рд╣реВрдБтАж рдХреГрдкрдпрд╛ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рдЕрдиреБрдорддрд┐ рджреЗрдВред");

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const lat=pos.coords.latitude.toFixed(4);
        const lon=pos.coords.longitude.toFixed(4);
        const mapLink=`https://www.google.com/maps?q=${lat},${lon}`;

        addMessage("bot",(language==="en")
          ? `тЬЕ Location detected: ${lat}, ${lon}<br><a href="${mapLink}" target="_blank">Open in Maps</a>`
          : `тЬЕ рд╕реНрдерд╛рди рдорд┐рд▓рд╛: ${lat}, ${lon}<br><a href="${mapLink}" target="_blank">рдорд╛рдирдЪрд┐рддреНрд░ рдореЗрдВ рдЦреЛрд▓реЗрдВ</a>`);

        addMessage("bot",(language==="en")
          ? `ЁЯЪи You can share this location with police/parents. Quick Call: <a href="tel:112">112</a>`
          : `ЁЯЪи рдкреБрд▓рд┐рд╕/рдорд╛рддрд╛-рдкрд┐рддрд╛ рд╕реЗ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред рддреБрд░рдВрдд рдХреЙрд▓: <a href="tel:112">112</a>`);

        // ЁЯФе WhatsApp share option
        const div=document.createElement("div");
        div.className="temp-ui";
        div.innerHTML=`
          <input id="waLocNumber" placeholder="${language==="en"?"Enter WhatsApp number (e.g., 919876543210)":"рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рдирдВрдмрд░ рдбрд╛рд▓реЗрдВ (рдЬреИрд╕реЗ 919876543210)"}" style="width:100%;margin:6px 0;padding:6px;">
          <button class="btn" id="sendWALoc">${language==="en"?"ЁЯУ▓ Share Location on WhatsApp":"ЁЯУ▓ рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рдкрд░ рд╕реНрдерд╛рди рднреЗрдЬреЗрдВ"}</button>
        `;
        chat.appendChild(div);

        document.getElementById("sendWALoc").onclick=()=>{
          const num=document.getElementById("waLocNumber").value.trim();
          if(!/^\d{10,15}$/.test(num)){
            addMessage("bot",(language==="en")?"тЪая╕П Please enter a valid WhatsApp number.":"тЪая╕П рд╕рд╣реА рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рдирдВрдмрд░ рдбрд╛рд▓реЗрдВред");
            return;
          }
          const msg=(language==="en")
            ? `ЁЯЪи My current location is here: ${mapLink}`
            : `ЁЯЪи рдореЗрд░рд╛ рд╡рд░реНрддрдорд╛рди рд╕реНрдерд╛рди рдпрд╣рд╛рдБ рд╣реИ: ${mapLink}`;
          const waLink=`https://wa.me/${num}?text=${encodeURIComponent(msg)}`;
          window.open(waLink,"_blank");
        };

        autoScroll();
      },
      ()=>addMessage("bot",(language==="en")
        ? "тЪая╕П Location access denied."
        : "тЪая╕П рд╕реНрдерд╛рди рдХреА рдЕрдиреБрдорддрд┐ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХреА рдЧрдИред")
    );
  } else {
    addMessage("bot",(language==="en")
      ? "тЭМ Your browser does not support location."
      : "тЭМ рдЖрдкрдХрд╛ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рд╕реНрдерд╛рди рд╕рдкреЛрд░реНрдЯ рдирд╣реАрдВ рдХрд░рддрд╛ред");
  }
  addBack();
}
function reportForm(){
  setMascotMood("bulb_serious");
  addMessage("bot",(language==="en")
    ? "ЁЯУЭ Fill this quick form to create a report you can share with a teacher/parent or friend on WhatsApp."
    : "ЁЯУЭ рдЗрд╕ рдЫреЛрдЯреЗ рдлреЙрд░реНрдо рдХреЛ рднрд░реЗрдВ рддрд╛рдХрд┐ рдЖрдк рд╢рд┐рдХреНрд╖рдХ/рдорд╛рддрд╛-рдкрд┐рддрд╛ рдпрд╛ рдорд┐рддреНрд░ рдХреЛ рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рдкрд░ рд░рд┐рдкреЛрд░реНрдЯ рднреЗрдЬ рд╕рдХреЗрдВред");

  const formDiv=document.createElement("div");
  formDiv.className="temp-ui";

  formDiv.innerHTML=`
    <input type="text" id="who" placeholder="${language==="en"?"Who bullied you?":"рдХрд┐рд╕рдиреЗ рдмрджрдорд╛рд╢реА рдХреА?"}" style="width:100%;margin:5px 0;padding:6px;">
    <input type="text" id="where" placeholder="${language==="en"?"Where did it happen?":"рдпрд╣ рдХрд╣рд╛рдБ рд╣реБрдЖ?"}" style="width:100%;margin:5px 0;padding:6px;">
    <textarea id="what" placeholder="${language==="en"?"Describe what happened":"рдХреНрдпрд╛ рд╣реБрдЖ рдмрддрд╛рдЗрдП"}" style="width:100%;height:80px;margin:5px 0;padding:6px;"></textarea>
    <button class="btn" id="submitReport">${language==="en"?"ЁЯУд Generate Report":"ЁЯУд рд░рд┐рдкреЛрд░реНрдЯ рдмрдирд╛рдПрдБ"}</button>
  `;
  chat.appendChild(formDiv);

  document.getElementById("submitReport").onclick=()=>{
    const who=document.getElementById("who").value.trim();
    const where=document.getElementById("where").value.trim();
    const what=document.getElementById("what").value.trim();

    if(!who||!where||!what){
      addMessage("bot",(language==="en")?"тЪая╕П Please fill all fields.":"тЪая╕П рдХреГрдкрдпрд╛ рд╕рднреА рдЬрд╛рдирдХрд╛рд░реА рднрд░реЗрдВред");
      return;
    }

    const reportText=(language==="en")
      ? `ЁЯУЛ Bullying Report:\nWho: ${who}\nWhere: ${where}\nWhat: ${what}`
      : `ЁЯУЛ рдмрджрдорд╛рд╢реА рд░рд┐рдкреЛрд░реНрдЯ:\nрдХреМрди: ${who}\nрдХрд╣рд╛рдБ: ${where}\nрдХреНрдпрд╛ рд╣реБрдЖ: ${what}`;

    addMessage("bot",reportText.replace(/\n/g,"<br>"));

    // allow download
    let blob=new Blob([reportText],{type:"text/plain"});
    let link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="Bullying_Report.txt";
    link.textContent=(language==="en")?"тмЗя╕П Download Report":"тмЗя╕П рд░рд┐рдкреЛрд░реНрдЯ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ";
    chat.appendChild(link);

    // ЁЯФе Ask number for WhatsApp share
    const phoneDiv=document.createElement("div");
    phoneDiv.className="temp-ui";
    phoneDiv.innerHTML=`
      <input id="waNumber" placeholder="${language==="en"?"Enter WhatsApp number (e.g., 919876543210)":"рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рдирдВрдмрд░ рдбрд╛рд▓реЗрдВ (рдЬреИрд╕реЗ 919876543210)"}" style="width:100%;margin:6px 0;padding:6px;">
      <button class="btn" id="sendWAReport">${language==="en"?"ЁЯУ▓ Send via WhatsApp":"ЁЯУ▓ рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рд╕реЗ рднреЗрдЬреЗрдВ"}</button>
    `;
    chat.appendChild(phoneDiv);

    document.getElementById("sendWAReport").onclick=()=>{
      const num=document.getElementById("waNumber").value.trim();
      if(!/^\d{10,15}$/.test(num)){
        addMessage("bot",(language==="en")?"тЪая╕П Please enter a valid WhatsApp number.":"тЪая╕П рд╕рд╣реА рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рдирдВрдмрд░ рдбрд╛рд▓реЗрдВред");
        return;
      }
      const waLink=`https://wa.me/${num}?text=${encodeURIComponent(reportText)}`;
      window.open(waLink,"_blank");
    };

    autoScroll();
  };

  addBack();
}

function addBack(){
  const b=document.createElement("button");
  b.className="back-btn";
  b.textContent=texts[language].back;
  b.onclick=(e)=>{ 
    e.preventDefault();

    // ЁЯЫС stop any ongoing speech immediately
    speechSynthesis.cancel();

    // reset bullying state on back
    state.awaitingBullyingCategory=false;
    state.awaitingBullyingType=false;
    state.bullyingPersona=null;

    // clear temp UI
    chat.querySelectorAll(".temp-ui").forEach(x=>x.remove());

    // return to menu
    showMenu(); 
    setMascotMood("bulb_default");
  };
  chat.appendChild(b);
}

/* ----------------- Sections: Bullying flow, Advice, Report, Roleplay ----------------- */
function explainBullying(){
  setMascotMood("bulb_serious");
  addMessage("bot",texts[language].bullying);
  addImage("bullying.jpeg");
  // start category question
  state.awaitingBullyingCategory=true;
  state.awaitingBullyingType=false;
  state.bullyingPersona=null;
  const q = (language==="en")
    ? "Are you a <b>child</b>, <b>adult</b>, or <b>old man</b>? Type your choice or tap a button:"
    : "рдХреНрдпрд╛ рдЖрдк <b>рдмрдЪреНрдЪреЗ</b>, <b>рд╡рдпрд╕реНрдХ</b> рдпрд╛ <b>рдмреБрдЬрд╝реБрд░реНрдЧ</b> рд╣реИрдВ? рдЕрдкрдирд╛ рд╡рд┐рдХрд▓реНрдк рдЯрд╛рдЗрдк рдХрд░реЗрдВ рдпрд╛ рдмрдЯрди рджрдмрд╛рдПрдБ:";
  addMessage("bot","ЁЯСА "+q);
  addChoiceButtons((language==="en"?["Child","Adult","Old man"]:["рдмрдЪреНрдЪрд╛","рд╡рдпрд╕реНрдХ","рдмреБрдЬрд╝реБрд░реНрдЧ"]),(label)=>{ handleBullyingCategoryInput(label); });
  addBack();
}
function giveAdvice(){ setMascotMood("bulb_happy"); addMessage("bot",texts[language].advice); addImage("advice.jpeg"); addBack(); }
function reportBullying(){ setMascotMood("bulb_serious"); addMessage("bot",texts[language].report); addImage("report.jpeg"); addBack(); }
function startRoleplay(){ 
  setMascotMood("bulb_thinking"); 
  state.awaitingRoleplay=true;

  // pick random scenario
  const scenarios = roleplayScenarios[language];
  const randomScenario = scenarios[Math.floor(Math.random()*scenarios.length)];

  addMessage("bot","ЁЯОн "+randomScenario); 
  addImage("roleplay.jpeg"); 
  addBack(); 
}
function handleRoleplayResponse(text){
  let safe = false;

  if(language==="en"){
    safe = /(stop|leave me|respect|not okay|teacher|report|block|this is wrong|donтАЩt do that)/i.test(text);
  } else {
    safe = /(рд░реБрдХ|рдордд рдХрд░реЛ|рд╕рдореНрдорд╛рди|рдареАрдХ рдирд╣реАрдВ|рд╢рд┐рдХреНрд╖рдХ|рд░рд┐рдкреЛрд░реНрдЯ|рдмреНрд▓реЙрдХ|рдЧрд▓рдд рд╣реИ|рдирд╣реАрдВ рдХрд░рдирд╛)/i.test(text);
  }

  if(safe){ 
    setMascotMood("bulb_happy"); 
    addMessage("bot",(language==="en")?"тнР Great response!":"тнР рдЕрдЪреНрдЫрд╛ рдЬрд╡рд╛рдм!"); 
  }
  else { 
    setMascotMood("bulb_serious"); 
    addMessage("bot",(language==="en")?"ЁЯТб Try: 'I want this to stop.'":"ЁЯТб рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ: 'рдореИрдВ рдЪрд╛рд╣рддрд╛ рд╣реВрдБ рдпрд╣ рд░реБрдХреЗред'"); 
  }

  state.awaitingRoleplay=false; 
  addBack();
}

/* ----------------- Quiz ----------------- */
const quizQuestions = {
  en:[
    {q:"Which of these is bullying?",options:["Teasing once","Helping a friend","Repeatedly making fun of someone"],answer:2},
    {q:"What should you do if you see bullying?",options:["Ignore it","Support the target and report it","Join in"],answer:1},
    {q:"Online bullying is also called?",options:["Cyberbullying","Play fight","Prank"],answer:0}
  ],
  hi:[
    {q:"рдЗрдирдореЗрдВ рд╕реЗ рдХреМрди рдмрджрдорд╛рд╢реА рд╣реИ?",options:["рдПрдХ рдмрд╛рд░ рдЪрд┐рдврд╝рд╛рдирд╛","рдорд┐рддреНрд░ рдХреА рдорджрдж рдХрд░рдирд╛","рдмрд╛рд░-рдмрд╛рд░ рдордЬрд╛рдХ рдЙрдбрд╝рд╛рдирд╛"],answer:2},
    {q:"рдЕрдЧрд░ рдЖрдк рдмрджрдорд╛рд╢реА рджреЗрдЦреЗрдВ рддреЛ рдХреНрдпрд╛ рдХрд░реЗрдВ?",options:["рдЕрдирджреЗрдЦрд╛ рдХрд░реЗрдВ","рдкреАрдбрд╝рд┐рдд рдХрд╛ рд╕рд╛рде рджреЗрдВ рдФрд░ рд░рд┐рдкреЛрд░реНрдЯ рдХрд░реЗрдВ","рд╢рд╛рдорд┐рд▓ рд╣реЛ рдЬрд╛рдПрдБ"],answer:1},
    {q:"рдСрдирд▓рд╛рдЗрди рдмрджрдорд╛рд╢реА рдХреЛ рдХреНрдпрд╛ рдХрд╣рддреЗ рд╣реИрдВ?",options:["рд╕рд╛рдЗрдмрд░рдмреБрд▓рд┐рдВрдЧ","рдЦреЗрд▓ рдЭрдЧрдбрд╝рд╛","рдордЬрд╛рдХ"],answer:0}
  ]
};
function startQuiz(){
  setMascotMood("bulb_thinking");
  state.awaitingQuiz=true; state.quizIndex=0; state.quizScore=0;
  addMessage("bot",texts[language].quizIntro); addImage("quiz.jpeg");
  showQuizQuestion(); addBack();
}
function showQuizQuestion(){
  setMascotMood("bulb_thinking");
  const q = quizQuestions[language][state.quizIndex];
  addMessage("bot",`Q${state.quizIndex+1}: ${q.q}`);
  const opts=document.createElement("div"); opts.className="quiz-options temp-ui";
  q.options.forEach((opt,i)=>{
    const btn=document.createElement("button"); btn.className="btn"; btn.textContent=(i+1)+". "+opt;
    btn.onclick=()=>handleQuizAnswer(btn,i); opts.appendChild(btn);
  });
  chat.appendChild(opts); autoScroll();
}
function handleQuizAnswer(btn,choice){
  const q=quizQuestions[language][state.quizIndex];
  btn.parentNode.querySelectorAll("button").forEach(b=>b.disabled=true);
  if(choice===q.answer){
    setMascotMood("bulb_happy"); addMessage("bot",(language==="en")?"тЬЕ Correct!":"тЬЕ рд╕рд╣реА рдЬрд╡рд╛рдм!"); playClap(); btn.style.background="#22c55e"; state.quizScore++;
  } else {
    setMascotMood("bulb_serious");
    addMessage("bot",(language==="en")?"тЭМ Wrong. Correct: "+q.options[q.answer]:"тЭМ рдЧрд▓рддред рд╕рд╣реА рдЙрддреНрддрд░: "+q.options[q.answer]);
    btn.style.background="#ef4444";
  }
  state.quizIndex++;
  chat.querySelectorAll(".temp-ui").forEach(x=>x.remove());
  if(state.quizIndex<quizQuestions[language].length){ setTimeout(showQuizQuestion,800); }
  else {
    setMascotMood("bulb_cheer");
    addMessage("bot",(language==="en")
      ? `ЁЯОЙ Quiz finished! Score: ${state.quizScore} out of ${quizQuestions[language].length}`
      : `ЁЯОЙ рдХреНрд╡рд┐рдЬрд╝ рд╕рдорд╛рдкреНрдд! рд╕реНрдХреЛрд░: ${state.quizScore} out of ${quizQuestions[language].length}`);
    state.awaitingQuiz=false;
  }
}

/* ----------------- Pledge ----------------- */
function pledge(){
  setMascotMood("bulb_cheer");
  state.awaitingPledge=true;
  const pledgeText=texts[language].pledge;
  const pledgeDiv=document.createElement("div");
  pledgeDiv.className="pledge-text";
  pledgeText.split(" ").forEach((w,i)=>{
    const span=document.createElement("span");
    span.textContent=w+" "; span.id="pledgeWord"+i; pledgeDiv.appendChild(span);
  });
  chat.appendChild(pledgeDiv);
  addImage("pledge.jpeg");
  addMessage("bot",(language==="en")?"ЁЯТЦ Repeat after me:":"ЁЯТЦ рдореЗрд░реЗ рдмрд╛рдж рдмреЛрд▓реЛ:");
  const utter=new SpeechSynthesisUtterance(pledgeText);
  utter.lang=(language==="en")?"en-US":"hi-IN";
  let i=0; const words=pledgeText.split(" ");
  utter.onboundary=()=>{ if(i<words.length){
    document.querySelectorAll(".pledge-text span").forEach(s=>s.classList.remove("active"));
    const cur=document.getElementById("pledgeWord"+i); if(cur) cur.classList.add("active"); i++; } };
  speechSynthesis.speak(utter);
  addBack();
}
function handlePledgeResponse(text){
  if(language==="en"){
    if(text.toLowerCase().includes("i pledge") && text.toLowerCase().includes("bullying")){
      setMascotMood("bulb_wave"); addMessage("bot","ЁЯМЯ Wonderful! You spoke the pledge with courage."); playClap(); state.awaitingPledge=false;
    } else { addMessage("bot","тЪая╕П Please try again and say the pledge clearly."); }
  } else {
    if(text.includes("рдореИрдВ") && text.includes("рдмрджрдорд╛рд╢реА")){
      setMascotMood("bulb_wave"); addMessage("bot","ЁЯМЯ рд╢рд╛рдирджрд╛рд░! рдЖрдкрдиреЗ рд╢рдкрде рд▓реАред"); state.awaitingPledge=false;
    } else { addMessage("bot","тЪая╕П рдХреГрдкрдпрд╛ рдлрд┐рд░ рд╕реЗ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ рдФрд░ рд╢рдкрде рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдмреЛрд▓реЗрдВред"); }
  }
}

/* ----------------- Search fallback ----------------- */
async function searchAndAnswer(query){
  try {
    addMessage("bot","ЁЯФО Let me check that for you...");
    const url="https://api.duckduckgo.com/?q="+encodeURIComponent(query)+"&format=json";
    const res=await fetch(url);
    const data=await res.json();
    let answer=data.AbstractText || data.Heading || "Sorry, I couldn't find anything clear.";
    addMessage("bot",answer);
  } catch (e){ addMessage("bot","тЪая╕П Error fetching answer."); }
}

/* ----------------- Bullying helpers ----------------- */
function handleBullyingCategoryInput(text){
  const t=text.toLowerCase();
  chat.querySelectorAll(".temp-ui").forEach(x=>x.remove());
  if(/child/.test(t) || (language==="hi" && /рдмрдЪреНрдЪрд╛|рдмрдЪреНрдЪреЗ/.test(t))){ state.bullyingPersona="child"; }
  else if(/adult/.test(t) || (language==="hi" && /рд╡рдпрд╕реНрдХ/.test(t))){ state.bullyingPersona="adult"; }
  else if(/old/.test(t) || (language==="hi" && /рдмреБрдЬрд╝реБрд░реНрдЧ|рдмреБрдЬреБрд░реНрдЧ/.test(t))){ state.bullyingPersona="old"; }
  else {
    addMessage("bot", (language==="en") ? "тЪая╕П Please type <b>child</b>, <b>adult</b>, or <b>old man</b>." : "тЪая╕П рдХреГрдкрдпрд╛ <b>рдмрдЪреНрдЪрд╛</b>, <b>рд╡рдпрд╕реНрдХ</b> рдпрд╛ <b>рдмреБрдЬрд╝реБрд░реНрдЧ</b> рд▓рд┐рдЦреЗрдВред");
    addChoiceButtons((language==="en" ? ["Child","Adult","Old man"] : ["рдмрдЪреНрдЪрд╛","рд╡рдпрд╕реНрдХ","рдмреБрдЬрд╝реБрд░реНрдЧ"]),(label)=>handleBullyingCategoryInput(label));
    return;
  }

  state.awaitingBullyingCategory=false;
  state.awaitingBullyingType=true;

  let prompt="", options=[];
  if(language==="en"){
    if(state.bullyingPersona==="child"){ prompt="What kind of bullying? (physical / verbal / cyber)"; options=["Physical","Verbal","Cyber"]; }
    if(state.bullyingPersona==="adult"){ prompt="What kind of bullying? (workplace / social / online)"; options=["Workplace","Social","Online"]; }
    if(state.bullyingPersona==="old"){ prompt="What kind of bullying? (neglect / disrespect / financial)"; options=["Neglect","Disrespect","Financial"]; }
  } else {
    if(state.bullyingPersona==="child"){ prompt="рдХрд┐рд╕ рдкреНрд░рдХрд╛рд░ рдХреА рдмрджрдорд╛рд╢реА? (рд╢рд╛рд░реАрд░рд┐рдХ / рдореМрдЦрд┐рдХ / рдСрдирд▓рд╛рдЗрди)"; options=["рд╢рд╛рд░реАрд░рд┐рдХ","рдореМрдЦрд┐рдХ","рдСрдирд▓рд╛рдЗрди"]; }
    if(state.bullyingPersona==="adult"){ prompt="рдХрд┐рд╕ рдкреНрд░рдХрд╛рд░ рдХреА рдмрджрдорд╛рд╢реА? (рдХрд╛рд░реНрдпрд╕реНрдерд▓ / рд╕рд╛рдорд╛рдЬрд┐рдХ / рдСрдирд▓рд╛рдЗрди)"; options=["рдХрд╛рд░реНрдпрд╕реНрдерд▓","рд╕рд╛рдорд╛рдЬрд┐рдХ","рдСрдирд▓рд╛рдЗрди"]; }
    if(state.bullyingPersona==="old"){ prompt="рдХрд┐рд╕ рдкреНрд░рдХрд╛рд░ рдХрд╛ рджреБрд░реНрд╡реНрдпрд╡рд╣рд╛рд░? (рдЙрдкреЗрдХреНрд╖рд╛ / рдЕрд╕рдореНрдорд╛рди / рдЖрд░реНрдерд┐рдХ)"; options=["рдЙрдкреЗрдХреНрд╖рд╛","рдЕрд╕рдореНрдорд╛рди","рдЖрд░реНрдерд┐рдХ"]; }
  }
  setMascotMood("bulb_thinking");
  addMessage("bot","ЁЯТн "+prompt);
  addChoiceButtons(options,(label)=>handleBullyingTypeInput(label));
}
function handleBullyingTypeInput(text){
  const t=text.toLowerCase();
  chat.querySelectorAll(".temp-ui").forEach(x=>x.remove());
  let reply="";
  if(language==="en"){
    if(state.bullyingPersona==="child"){
      if(/physical/.test(t)) reply="ЁЯПГ Tell a teacher or parent immediately. Stay with friends for safety.";
      else if(/verbal/.test(t)) reply="ЁЯЧгя╕П Stay calm, use a firm voice, and report to a trusted adult.";
      else if(/cyber/.test(t)) reply="ЁЯТ╗ Block/report the bully online and show messages to a guardian.";
    } else if(state.bullyingPersona==="adult"){
      if(/workplace/.test(t)) reply="ЁЯТ╝ Document incidents, talk to HR/management, and seek formal support.";
      else if(/social/.test(t)) reply="ЁЯСе Set boundaries, lean on supportive friends/family, consider mediation.";
      else if(/online/.test(t)) reply="ЁЯМР Block/report abuse, secure accounts, consider legal/cybercrime help.";
    } else if(state.bullyingPersona==="old"){
      if(/neglect/.test(t)) reply="ЁЯдЭ Contact social services/NGOs or a trusted neighbor for immediate support.";
      else if(/disrespect/.test(t)) reply="ЁЯТм Share concerns with family/community leaders; ask for respect and safety.";
      else if(/financial/.test(t)) reply="ЁЯТ░ Protect assets; consult a lawyer or helpline about financial exploitation.";
    }
  } else {
    if(state.bullyingPersona==="child"){
      if(/рд╢рд╛рд░реАрд░рд┐рдХ/.test(t)) reply="ЁЯПГ рддреБрд░рдВрдд рд╢рд┐рдХреНрд╖рдХ/рдорд╛рддрд╛-рдкрд┐рддрд╛ рдХреЛ рдмрддрд╛рдПрдВред рджреЛрд╕реНрддреЛрдВ рдХреЗ рд╕рд╛рде рд░рд╣реЗрдВред";
      else if(/рдореМрдЦрд┐рдХ/.test(t)) reply="ЁЯЧгя╕П рд╢рд╛рдВрдд рд░рд╣реЗрдВ, рджреГрдврд╝рддрд╛ рд╕реЗ рдмреЛрд▓реЗрдВ, рдФрд░ рдХрд┐рд╕реА рдмрдбрд╝реЗ рдХреЛ рдмрддрд╛рдПрдВред";
      else if(/рдСрдирд▓рд╛рдЗрди/.test(t)) reply="ЁЯТ╗ рдСрдирд▓рд╛рдЗрди рдмреНрд▓реЙрдХ/рд░рд┐рдкреЛрд░реНрдЯ рдХрд░реЗрдВ рдФрд░ рд╕рдВрджреЗрд╢ рдЕрднрд┐рднрд╛рд╡рдХ рдХреЛ рджрд┐рдЦрд╛рдПрдБред";
    } else if(state.bullyingPersona==="adult"){
      if(/рдХрд╛рд░реНрдпрд╕реНрдерд▓/.test(t)) reply="ЁЯТ╝ рдШрдЯрдирд╛рдПрдБ рджрд░реНрдЬ рдХрд░реЗрдВ, HR/рдкреНрд░рдмрдВрдзрди рд╕реЗ рдмрд╛рдд рдХрд░реЗрдВ, рдФрдкрдЪрд╛рд░рд┐рдХ рд╕рд╣рд╛рдпрддрд╛ рд▓реЗрдВред";
      else if(/рд╕рд╛рдорд╛рдЬрд┐рдХ/.test(t)) reply="ЁЯСе рд╕реАрдорд╛рдПрдБ рддрдп рдХрд░реЗрдВ, рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдорд┐рддреНрд░/рдкрд░рд┐рд╡рд╛рд░ рдХрд╛ рд╕рд╣рд╛рд░рд╛ рд▓реЗрдВред";
      else if(/рдСрдирд▓рд╛рдЗрди/.test(t)) reply="ЁЯМР рдмреНрд▓реЙрдХ/рд░рд┐рдкреЛрд░реНрдЯ рдХрд░реЗрдВ, рдЕрдХрд╛рдЙрдВрдЯ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░реЗрдВ, рд╕рд╛рдЗрдмрд░ рд╣реЗрд▓реНрдкрд▓рд╛рдЗрди рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдВред";
    } else if(state.bullyingPersona==="old"){
      if(/рдЙрдкреЗрдХреНрд╖рд╛/.test(t)) reply="ЁЯдЭ рд╕рд╛рдорд╛рдЬрд┐рдХ рд╕реЗрд╡рд╛рдУрдВ/NGO рдпрд╛ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдкрдбрд╝реЛрд╕реА рд╕реЗ рдорджрдж рд▓реЗрдВред";
      else if(/рдЕрд╕рдореНрдорд╛рди/.test(t)) reply="ЁЯТм рдкрд░рд┐рд╡рд╛рд░/рд╕рдореБрджрд╛рдп рд╕реЗ рдмрд╛рдд рдХрд░реЗрдВ; рд╕рдореНрдорд╛рди рд╡ рд╕реБрд░рдХреНрд╖рд╛ рдХреА рдорд╛рдВрдЧ рдХрд░реЗрдВред";
      else if(/рдЖрд░реНрдерд┐рдХ/.test(t)) reply="ЁЯТ░ рд╕рдВрдкрддреНрддрд┐ рд╕реБрд░рдХреНрд╖рд╛ рдХрд░реЗрдВ; рдЖрд░реНрдерд┐рдХ рд╢реЛрд╖рдг рдкрд░ рдХрд╛рдиреВрдиреА рд╕рд▓рд╛рд╣ рд▓реЗрдВред";
    }
  }

  if(reply){
  setMascotMood("bulb_happy");

  // Show advice
  addMessage("bot", reply);


  // Speak thank-you AFTER a small pause
  setTimeout(()=>{
    addMessage("bot", (language==="en")
      ? "тЬЕ Thank you for sharing. You can use the Back button to return to the menu."
      : "тЬЕ рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдзрдиреНрдпрд╡рд╛рджред рдореЗрдиреНрдпреВ рдкрд░ рд▓реМрдЯрдиреЗ рдХреЗ рд▓рд┐рдП Back рдмрдЯрди рджрдмрд╛рдПрдБред");
  }, 2000); // 2 sec delay

  state.awaitingBullyingType=false;
  state.bullyingPersona=null;
}



}

/* ----------------- Human verification (integrated) ----------------- */
function cleanForSpeech(text) {
  // Remove emojis/symbols but keep letters/numbers
  return text.replace(/[^\p{L}\p{N}\s.,!?'"-]/gu, "").trim();
}

function generateHumanCode(){
  const code = Math.floor(1000 + Math.random() * 9000); // 4-digit
  state.secretCode = String(code);
  state.codeAttempts = 0;
  state.awaitingCode = true;
  return state.secretCode;
}
function askHumanVerification(onlyRefresh=false){
  // remove temp-ui so refresh button shows single copy
  chat.querySelectorAll(".temp-ui").forEach(x=>x.remove());
  const code = state.secretCode || generateHumanCode();
  const msg = (language === "en")
    ? `ЁЯдЦ Before we start, please type this code to prove you are human: <b>${code}</b>`
    : `ЁЯдЦ рд╢реБрд░реВ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдХреГрдкрдпрд╛ рдпрд╣ рдХреЛрдб рдЯрд╛рдЗрдк рдХрд░реЗрдВ: <b>${code}</b>`;
  if(!onlyRefresh) addMessage("bot", msg);
  // create a small refresh UI below message
  addChoiceButtons([(language==="en")?"Refresh code":"рдХреЛрдб рдмрджрд▓реЗрдВ"],()=>{
    const newCode = generateHumanCode();
    addMessage("bot", (language==="en") ? `ЁЯФБ New code: <b>${newCode}</b>` : `ЁЯФБ рдирдпрд╛ рдХреЛрдб: <b>${newCode}</b>`);
  });
}

/* ----------------- Handle user input (main) ----------------- */
function analyzeBullyingSituation(text){
  state.awaitingBullyingDetect = false;
  const lower=text.toLowerCase();
  let result="";

  // simple keyword checks
  const physical=["hit","push","kick","slap","beat"];
  const verbal=["insult","stupid","ugly","abuse","curse","mock"];
  const cyber=["online","post","comment","whatsapp","facebook","instagram","troll"];
  const power=["teacher","boss","senior","group","gang","older"];

  let detected=[];

  if(physical.some(w=>lower.includes(w))) detected.push("physical harm");
  if(verbal.some(w=>lower.includes(w))) detected.push("verbal abuse");
  if(cyber.some(w=>lower.includes(w))) detected.push("cyberbullying");
  if(power.some(w=>lower.includes(w))) detected.push("power imbalance");

  if(detected.length>0){
    result = (language==="en")
      ? `тЪая╕П This situation shows signs of bullying: ${detected.join(", ")}.`
      : `тЪая╕П рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдмрджрдорд╛рд╢реА рдХреЗ рд╕рдВрдХреЗрдд рд╣реИрдВ: ${detected.join(", ")}.`;
  } else {
    result = (language==="en")
      ? "тЬЕ It does not strongly look like bullying, but always trust your feelings and stay safe."
      : "тЬЕ рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдмрджрдорд╛рд╢реА рдирд╣реАрдВ рд▓рдЧрддреА, рд▓реЗрдХрд┐рди рд╣рдореЗрд╢рд╛ рдЕрдкрдиреА рднрд╛рд╡рдирд╛ рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░реЗрдВ рдФрд░ рд╕реБрд░рдХреНрд╖рд┐рдд рд░рд╣реЗрдВред";
  }

  addMessage("bot",result);
  addMessage("bot",(language==="en")
    ? "ЁЯСЙ You can go back to the menu for more help."
    : "ЁЯСЙ рдЕрдзрд┐рдХ рдорджрдж рдХреЗ рд▓рд┐рдП рдореЗрдиреНрдпреВ рдкрд░ рд╡рд╛рдкрд╕ рдЬрд╛рдПрдБред");
}

function handleUserInput(text){
  // 1) Human verification step (if pending)
if(state.awaitingBullyingDetect){
  analyzeBullyingSituation(text);
  return;
}
  if (state.awaitingCode) {
    const cleaned = text.trim();
    if (cleaned === String(state.secretCode)) {
      state.awaitingCode = false;
      addMessage("bot", (language==="en") ? "тЬЕ Code correct! You are verified." : "тЬЕ рдХреЛрдб рд╕рд╣реА рд╣реИ! рдЖрдк рд╕рддреНрдпрд╛рдкрд┐рдд рд╣реЛ рдЧрдП рд╣реИрдВред");
      addMessage("bot", texts[language].intro, false, "happy");
      return;
    } else {
      state.codeAttempts = (state.codeAttempts || 0) + 1;
      if (state.codeAttempts >= state.maxCodeAttempts) {
        const newCode = generateHumanCode();
        addMessage("bot", (language==="en")
          ? `тЪая╕П Too many incorrect attempts. Here's a new code: <b>${newCode}</b>`
          : `тЪая╕П рдмрд╣реБрдд рдкреНрд░рдпрд╛рд╕ рд╣реБрдПред рдирдпрд╛ рдХреЛрдб: <b>${newCode}</b>`);
        // show refresh button too
        addChoiceButtons([(language==="en")?"Refresh code":"рдХреЛрдб рдмрджрд▓реЗрдВ"],()=>{
          const nc = generateHumanCode();
          addMessage("bot", (language==="en") ? `ЁЯФБ New code: <b>${nc}</b>` : `ЁЯФБ рдирдпрд╛ рдХреЛрдб: <b>${nc}</b>`);
        });
      } else {
        addMessage("bot", (language==="en")
          ? `тЪая╕П Wrong code. Please type exact code:`
          : `тЪая╕П рдЧрд▓рдд рдХреЛрдбред рдХреГрдкрдпрд╛ рдареАрдХ рдЯрд╛рдЗрдк рдХрд░реЗрдВ:`);
      }
      return;
    }
  }

  // 2) Normal bot flows below
  if(state.awaitingName){
    state.awaitingName=false;
    state.userName=text;
    addMessage("bot",`${texts[language].nice} <b>${state.userName}</b>!`);
    showMenu();
    return;
  }
  if(state.awaitingBullyingCategory){ handleBullyingCategoryInput(text); return; }
  if(state.awaitingBullyingType){ handleBullyingTypeInput(text); return; }
  if(state.awaitingRoleplay){ handleRoleplayResponse(text); return; }
  if(state.awaitingPledge){ handlePledgeResponse(text); return; }
  if(state.awaitingQuiz){ return; } // quiz uses buttons; ignore text during quiz
  // fallback search
  searchAndAnswer(text);
}

/* ----------------- Form submit ----------------- */
document.getElementById("composer").addEventListener("submit",e=>{
  e.preventDefault();
  const text=document.getElementById("input").value.trim();
  if(!text) return;
  addMessage("user",text);
  document.getElementById("input").value="";
  handleUserInput(text);
});

/* ----------------- Mascot vertical bounce ----------------- */
let dy = 2;
function bounceMascotVertical() {
  const app = document.querySelector(".app");
  const mascotHeight = mascot.clientHeight || 180;
  let y = parseInt(mascot.style.top || "150");
  y += dy;
  const x = app.clientWidth - mascot.clientWidth - 20;
  mascot.style.left = x + "px";
  const minY = 120;
  const maxY = app.clientHeight - mascotHeight - 20;
  if (y <= minY || y >= maxY) { dy = -dy; }
  mascot.style.top = y + "px";
  requestAnimationFrame(bounceMascotVertical);
}
window.onload = () => {
  const app = document.querySelector(".app");
  const x = app.clientWidth - mascot.clientWidth - 20;
  mascot.style.left = x + "px";
  mascot.style.top = "150px";
  bounceMascotVertical();
  // start human verification prompt
  askHumanVerification();
};

/* ----------------- Angry reaction ----------------- */
function angrySpeak(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 1;
  utterance.pitch = 0.6;
  utterance.volume = 1;
  speechSynthesis.speak(utterance);
}
function playSiren() {
  const siren = new Audio("siren.mp3");
  siren.play();
  setTimeout(() => {
    siren.pause();
    siren.currentTime = 0;
  }, 5000);
}
document.getElementById("mascot").addEventListener("click", () => {
  const m = document.getElementById("mascot");
  m.classList.add("angry");
  angrySpeak((language==="en")?"Stay away!":"рджреВрд░ рд░рд╣реЗрдВ!");
  playSiren();
  setTimeout(()=>{ m.classList.remove("angry"); }, 5000);
});
// ЁЯОЩя╕П Voice input
let recognition;
if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    addMessage("user", transcript);     // show what user said
    handleUserInput(transcript);        // process as normal input
  };

  recognition.onerror = (event) => {
    addMessage("bot", (language==="en") 
      ? "тЪая╕П I couldn't hear you properly. Please try again." 
      : "тЪая╕П рдореИрдВ рдЖрдкрдХреЛ рдареАрдХ рд╕реЗ рд╕реБрди рдирд╣реАрдВ рдкрд╛рдпрд╛ред рдХреГрдкрдпрд╛ рдлрд┐рд░ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред");
  };
}

</script>
</body>
</html>
