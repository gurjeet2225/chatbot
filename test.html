<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice4U ‚Äì Brave Buddy Chatbot</title>
  <style>
    body {
      margin:0; font-family:Arial,sans-serif; height:100vh;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(270deg,#ff6ec4,#7873f5,#4ade80,#facc15,#f87171);
      background-size:1000% 1000%; animation:rainbow 15s ease infinite;
    }
    @keyframes rainbow {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    .wrap { width:95%; max-width:900px; }
    .app { background: url('texture.jpg'); /* local image folder 'images' */ 
      background-size: cover;
      background-repeat: no-repeat;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      position: relative;
    }
    .heading { text-align: center;
      font-size: 34px;
      font-weight: bold;
      margin-bottom: 20px;
      background: linear-gradient(90deg, #ff0080, #7928ca, #2afadf);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: glow 3s infinite alternate;}
    @keyframes glow {
      0% { text-shadow:0 0 10px #ff0080,0 0 20px #ff0080; }
      100%{ text-shadow:0 0 25px #2afadf,0 0 40px #7928ca; }
    }
    .mascot { background-color: transparent; position:absolute; top:150px; right:10px; width:200px; height:200px;
      border-radius:0; cursor:pointer; transition:all 2s ease;}
    .angry {
      filter: hue-rotate(-50deg) saturate(5); /* turns reddish */
      animation: shake 0.3s infinite;
    }
    @keyframes shake {
      0% { transform: translate(0px, 0px) rotate(0deg); }
      20% { transform: translate(-5px, 0px) rotate(-2deg); }
      40% { transform: translate(5px, 0px) rotate(2deg); }
      60% { transform: translate(-5px, 0px) rotate(-2deg); }
      80% { transform: translate(5px, 0px) rotate(2deg); }
      100% { transform: translate(0px, 0px) rotate(0deg); }
    }
    .controls { display:flex; gap:10px; margin-bottom:10px;}
    .chat { height:350px; overflow-y:auto; margin-bottom:12px; background:rgba(255,255,255,0.5); border-radius:14px; padding:10px;}
    .msg { margin:6px 0;}
    .msg.user .bubble { background:#4ade80;color:white;border-radius:16px;padding:8px 12px;display:inline-block;}
    .msg.bot .bubble { background:#fff;border:1px solid #ddd;border-radius:16px;padding:8px 12px;display:inline-block;}
    .menu { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px;}
    .card { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);; border-radius:12px; padding:10px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
    .btn { padding:10px 16px; border:none; border-radius:12px; background:linear-gradient(135deg,#6366f1,#8b5cf6); color:white; font-weight:bold; cursor:pointer; transition:0.3s;}
    .btn:hover { transform:scale(1.08); background:linear-gradient(135deg,#8b5cf6,#6366f1); }
    .back-btn { margin-top:10px; background:linear-gradient(135deg,#10b981,#22d3ee); color:white; padding:10px; border:none; border-radius:12px; cursor:pointer; display:block; width:100%; font-weight:bold;}
    .quiz-options { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .quiz-options button { margin:4px; display:block; width:100%; transition:all 0.3s ease; }
    img.answer-img {
      width:250px;
      display: block;
      margin:10px auto;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.25);
    }
    .pledge-text { margin:12px 0; font-size:18px; font-weight:500; }
    .pledge-text span { color:black; transition:color 0.2s ease; }
    .pledge-text span.active { color:red; font-weight:bold; }
    textarea#input { width: calc(100% - 120px); height:48px; padding:8px; border-radius:8px; border:1px solid #ddd; resize:none; }
    form#composer { display:flex; gap:8px; align-items:center; }
    button[type="submit"] { min-width:110px; height:48px; }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="app">
      <div class="heading">üåü Brave Buddy ‚Äì For You üåü</div>
      <img src="images/bulb_default.png" class="mascot" id="mascot" alt="Mascot">

      <div class="controls">
        <button id="langToggle" class="btn">üåê Language: English</button>
        <button id="voiceBtn" class="btn" onclick="toggleVoice();playClick()">üîä Voice ON</button>
        <button id="micBtn" class="btn">üé§ Speak</button>
      </div>
      <audio id="clickSound" src="chime.mp3" preload="auto"></audio>
      <audio id="clapSound" src="clap.mp3" preload="auto"></audio>
      <section id="chat" class="chat" role="log" aria-live="polite"></section>
      <form id="composer" autocomplete="off">
        <textarea id="input" placeholder="Type here..."></textarea>
        <button class="btn" type="submit">Send ‚ñ∂</button>
      </form>
    </main>
  </div>

<script>
/* ----------------- Elements ----------------- */
const chat=document.getElementById("chat");
const mascot=document.getElementById("mascot");
const langToggle=document.getElementById("langToggle");
const micBtn=document.getElementById("micBtn");

/* ----------------- Settings & State ----------------- */
let language="en";
let voiceEnabled=true;
let voiceRate = 0.9;
let state = {
  awaitingName:true,
  userName:null,
  awaitingRoleplay:false,
  awaitingQuiz:false,
  quizIndex:0,
  quizScore:0,
  awaitingPledge:false,
  awaitingBullyingCategory:false,
  awaitingBullyingType:false,
  bullyingPersona:null,
  // Human verification fields
  awaitingCode:true,
  secretCode:null,
  codeAttempts:0,
  maxCodeAttempts:3
};

/* ----------------- Voice output ----------------- */
function toggleVoice() {
  voiceEnabled = !voiceEnabled;
  const btn = document.getElementById("voiceBtn");
  btn.innerText = voiceEnabled ? "üîä Voice ON" : "üîá Voice OFF";

  // Stop any current speech immediately when OFF
  if (!voiceEnabled) {
    speechSynthesis.cancel();
  }
}

function speak(text) {
  return new Promise((resolve) => {
    if (!voiceEnabled) { resolve(); return; }

    // stop old voice before starting new
    speechSynthesis.cancel();

    let cleaned = text
      .replace(/<b>\d+<\/b>/g, "")
      .replace(/<[^>]*>/g, "")
      .replace(/[^\p{L}\p{N}\s.,!?'"-]/gu, "")
      .replace(/\s+/g, " ")
      .trim();

    if (cleaned.length === 0) { resolve(); return; }

    let utterance = new SpeechSynthesisUtterance(cleaned);
    utterance.lang = (/[\u0900-\u097F]/.test(cleaned)) ? "hi-IN" : "en-US";
    utterance.rate = 0.9;

    utterance.onend = () => { autoScroll(); resolve(); };
    utterance.onboundary = autoScroll;

    speechSynthesis.speak(utterance);
  });

  // ‚ùå removed speechSynthesis.cancel() so it doesn‚Äôt cut earlier lines
}
micBtn.onclick = () => {
  if (recognition) {
    recognition.lang = (language === "en") ? "en-US" : "hi-IN";
    recognition.start();
    addMessage("bot", (language==="en") ? "üé§ Listening..." : "üé§ ‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...", true); // silent so it doesn‚Äôt speak
  } else {
    addMessage("bot", (language==="en") 
      ? "‚ö†Ô∏è Speech recognition not supported in this browser." 
      : "‚ö†Ô∏è ‡§Ø‡§π ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§µ‡•â‡§á‡§∏ ‡§∞‡§ø‡§ï‡§ó‡•ç‡§®‡§ø‡§∂‡§® ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ‡•§");
  }
};

/* ----------------- Mascot & Moods ----------------- */
function setMascotMood(mood){ mascot.src="images/"+mood+".png"; }
function playClap() {
  const clap = document.getElementById("clapSound");
  if (clap) { clap.currentTime = 0; clap.play(); }
}

/* ----------------- Chat UI helpers ----------------- */
function addMessage(role,text){
  const row=document.createElement("div");
  row.className="msg "+role;
  const bubble=document.createElement("div");
  bubble.className="bubble";
  bubble.innerHTML=text;
  row.appendChild(bubble);
  chat.appendChild(row);
  autoScroll();
  if(role==="bot") speak(text);
}
function addImage(src){
  const img=document.createElement("img");
  img.src="images/"+src;
  img.className="answer-img";
  chat.appendChild(img);
  autoScroll();
}
function autoScroll() {
  requestAnimationFrame(() => {
    chat.scrollTo({ top: chat.scrollHeight, behavior: "smooth" });
  });
}

/* ----------------- Texts ----------------- */
const texts = {
  en:{
    intro:"üëã Let‚Äôs introduce each other! First tell me your name. I am your Brave Buddy to give awareness on bullying.",
    nice:"Nice to meet you,",
    bullying:"Bullying = repeated harm with imbalance of power.",
    advice:"If you are being bullied Stay calm, walk away, save evidence, tell an adult. Advice If you want to give advice to a friend who is bullying someone is a sensitive situation and plan the conversation carefully by choosing the right time and place, set a positive tone, explain the consequences of bullying and be specific.",
    report:"Save proof, block/report, tell a teacher/parent.For any immediate threat or danger related to bullying always call your country's universal emergency number 112 (Emergency Response Support System-ERSS), Childline 1098 is a 24-hour, free, national emergency phone service. For women facing violence or harassment, including in workplace, The National Commission for Women has a helpline at 7827170170",
    role:"üé≠ Role-play: Someone says 'You‚Äôre not good enough.' What do you reply?",
    quizIntro:"üìù Let‚Äôs start the quiz!",
    pledge:"I pledge to stand against bullying and spread kindness.",
    closing:"üåü Thank you! You are a Brave Buddy!",
    back:"‚¨Ö Back to Menu"
  },
  hi:{
    intro:"üëã ‡§ö‡§≤‡•ã ‡§è‡§ï-‡§¶‡•Ç‡§∏‡§∞‡•á ‡§∏‡•á ‡§™‡§∞‡§ø‡§ö‡§Ø ‡§ï‡§∞‡•á‡§Ç! ‡§™‡§π‡§≤‡•á ‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¨‡§§‡§æ‡§á‡§è‡•§ ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡•á‡§µ ‡§¨‡§°‡•Ä ‡§π‡•Ç‡§Å ‡§ú‡•ã ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§ó‡§∞‡•Ç‡§ï‡§§‡§æ ‡§¶‡•á‡§§‡§æ ‡§π‡•à‡•§",
    nice:"‡§Ü‡§™‡§∏‡•á ‡§Æ‡§ø‡§≤‡§ï‡§∞ ‡§ñ‡•Å‡§∂‡•Ä ‡§π‡•Å‡§à,",
    bullying:"‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä = ‡§¨‡§æ‡§∞-‡§¨‡§æ‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§®‡•Å‡§ï‡§∏‡§æ‡§® ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§∂‡§ï‡•ç‡§§‡§ø ‡§ï‡§æ ‡§Ö‡§∏‡§Ç‡§§‡•Å‡§≤‡§® ‡§π‡•ã‡•§",
    advice:"‡§∂‡§æ‡§Ç‡§§ ‡§∞‡§π‡•á‡§Ç, ‡§¶‡•Ç‡§∞ ‡§ö‡§≤‡•á ‡§ú‡§æ‡§è‡§Å, ‡§∏‡§¨‡•Ç‡§§ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§ï‡§ø‡§∏‡•Ä ‡§¨‡§°‡§º‡•á ‡§ï‡•ã ‡§¨‡§§‡§æ‡§è‡§Ç‡•§",
    report:"‡§∏‡§¨‡•Ç‡§§ ‡§∞‡§ñ‡•á‡§Ç, ‡§¨‡•ç‡§≤‡•â‡§ï/‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï ‡§Ø‡§æ ‡§Æ‡§æ‡§§‡§æ-‡§™‡§ø‡§§‡§æ ‡§ï‡•ã ‡§¨‡§§‡§æ‡§è‡§Ç‡•§",
    role:"üé≠ ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§®‡§ø‡§≠‡§æ‡§è‡§Å: ‡§ï‡•ã‡§à ‡§ï‡§π‡•á '‡§§‡•Å‡§Æ ‡§Ö‡§ö‡•ç‡§õ‡•á ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡•§' ‡§Ü‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§Ç‡§ó‡•á?",
    quizIntro:"üìù ‡§ö‡§≤‡•ã ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç!",
    pledge:"‡§Æ‡•à‡§Ç ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§ï‡•á ‡§ñ‡§ø‡§≤‡§æ‡§´ ‡§ñ‡§°‡§º‡§æ ‡§∞‡§π‡•Ç‡§Å‡§ó‡§æ ‡§î‡§∞ ‡§¶‡§Ø‡§æ ‡§´‡•à‡§≤‡§æ‡§ä‡§Å‡§ó‡§æ‡•§",
    closing:"üåü ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§Ü‡§™ ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§ï‡•á ‡§ñ‡§ø‡§≤‡§æ‡§´ ‡§è‡§ï ‡§¨‡•ç‡§∞‡•á‡§µ ‡§¨‡§°‡•Ä ‡§π‡•à‡§Ç!",
    back:"‚¨Ö ‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Å"
  }
};

/* ----------------- Language toggle ----------------- */
langToggle.onclick=()=>{
  language=(language==="en")?"hi":"en";
  langToggle.textContent=(language==="en")?"üåê Language: English":"üåê ‡§≠‡§æ‡§∑‡§æ: ‡§π‡§ø‡§Ç‡§¶‡•Ä";
  // when language changes, if human verification still pending, show refreshed prompt
  if(state.awaitingCode){
    askHumanVerification(true); // refresh message only
  } else {
    showMenu();
  }
};

/* ----------------- Choice buttons helper ----------------- */
function addChoiceButtons(labels, onChoose){
  // remove any existing temp-ui
  document.querySelectorAll(".temp-ui").forEach(x=>x.remove());
  const box=document.createElement("div");
  box.className="quiz-options temp-ui";
  labels.forEach(l=>{
    const b=document.createElement("button");
    b.className="btn";
    b.textContent=l;
    b.onclick=(e)=>{ e.preventDefault(); onChoose(l); box.querySelectorAll("button").forEach(bb=>bb.disabled=true); };
    box.appendChild(b);
  });
  chat.appendChild(box); autoScroll();
}

/* ----------------- Menu & Navigation ----------------- */
function showMenu(){
  // remove previous temporary UIs
  chat.querySelectorAll(".menu,.back-btn,.temp-ui").forEach(o=>o.remove());
  const c=document.createElement("div"); 
  c.className="menu";

  const cards=[
    {t:(language==="en"?"üßò Calm Down Mode":"üßò ‡§∂‡§æ‡§Ç‡§§ ‡§∞‡§π‡§®‡•á ‡§ï‡§æ ‡§§‡§∞‡•Ä‡§ï‡§æ"), h:()=>calmDown()},   // ‚úÖ moved to first
    {t:(language==="en"?"ü§î Is it Bullying?":"ü§î ‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡§π ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§π‡•à?"), h:()=>detectBullying()},
    {t:(language==="en"?"What is bullying?":"‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?"), h:()=>explainBullying()},
    {t:(language==="en"?"Advice":"‡§∏‡§≤‡§æ‡§π"), h:()=>giveAdvice()},
    {t:(language==="en"?"Report bullying":"‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§ï‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü"), h:()=>reportBullying()},
    {t:(language==="en"?"Practice replies":"‡§ú‡§µ‡§æ‡§¨ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏"), h:()=>startRoleplay()},
    {t:(language==="en"?"Quick quiz":"‡§ï‡•ç‡§µ‡§ø‡§ú‡§º"), h:()=>startQuiz()},
    {t:(language==="en"?"üìç Share Location":"üìç ‡§∏‡•ç‡§•‡§æ‡§® ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç"), h:()=>askLocation()},
    {t:(language==="en"?"üìù Report Bullying Form":"üìù ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§´‡•â‡§∞‡•ç‡§Æ"), h:()=>reportForm()},
     {t:(language==="en"?"Closing / Pledge":"‡§∏‡§Æ‡§æ‡§™‡§® / ‡§∂‡§™‡§•"), h:()=>pledge()}
  ];

  cards.forEach(({t,h})=>{
    const card=document.createElement("div"); 
    card.className="card";
    card.innerHTML=`<h4>${t}</h4>`;
    const btn=document.createElement("button"); 
    btn.className="btn"; 
    btn.textContent="Open ‚ñ∂"; 
    btn.onclick=(e)=>{ e.preventDefault(); h(); };
    card.appendChild(btn); 
    c.appendChild(card);
  });

  chat.appendChild(c); 
  autoScroll();
}
async function calmDown(){
  setMascotMood("bulb_thinking");

  await speak((language==="en")
    ? "üßò Let's do a short breathing exercise. Follow my voice: Inhale‚Ä¶ Hold‚Ä¶ Exhale‚Ä¶"
    : "üßò ‡§ö‡§≤‡•ã ‡§è‡§ï ‡§õ‡•ã‡§ü‡§æ ‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Æ‡•á‡§∞‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§ï‡§æ ‡§Ö‡§®‡•Å‡§∏‡§∞‡§£ ‡§ï‡§∞‡•á‡§Ç: ‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§≤‡•ã‚Ä¶ ‡§∞‡•ã‡§ï‡•ã‚Ä¶ ‡§õ‡•ã‡§°‡§º‡•ã‚Ä¶"
  );

  const canvas=document.createElement("div");
  canvas.className="temp-ui";
  canvas.style.width="100%";
  canvas.style.height="200px";
  canvas.style.display="flex";
  canvas.style.alignItems="center";
  canvas.style.justifyContent="center";
  chat.appendChild(canvas);

  // Heart shape
const heart=document.createElement("div");
heart.style.position="relative";
heart.style.width="100px";
heart.style.height="90px";
heart.style.background="red";
heart.style.transform="rotate(-45deg) scale(1)";
heart.style.margin="20px";
heart.style.transition="all 4s ease-in-out";
heart.style.boxShadow="0 0 25px rgba(255,0,0,0.6), 0 0 50px rgba(255,0,0,0.4)";
canvas.appendChild(heart);

// Top left circle
const before=document.createElement("div");
before.style.content="''";
before.style.position="absolute";
before.style.width="100px";
before.style.height="100px";
before.style.borderRadius="50%";
before.style.background="red";
before.style.top="-50px";
before.style.left="0";
heart.appendChild(before);

// Top right circle
const after=document.createElement("div");
after.style.content="''";
after.style.position="absolute";
after.style.width="100px";
after.style.height="100px";
after.style.borderRadius="50%";
after.style.background="red";
after.style.left="50px";
after.style.top="0";
heart.appendChild(after);

let step=0;
async function breathe(){
  if(step%2===0){
    // Inhale - grow heart
    heart.style.transform="rotate(-45deg) scale(0.9)";
    heart.style.boxShadow="0 0 40px rgba(255,0,0,0.5), 0 0 80px rgba(255,0,0,0.3)";
    await speak((language==="en")?"üå¨Ô∏è Inhale":"üå¨Ô∏è ‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§≤‡•ã");
  } else {
    // Exhale - shrink heart
    heart.style.transform="rotate(-45deg) scale(1.4)";
    heart.style.boxShadow="0 0 15px rgba(255,0,0,0.8), 0 0 30px rgba(255,0,0,0.6)";
    await speak((language==="en")?"üòå Exhale":"üòå ‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§õ‡•ã‡§°‡§º‡•ã");
  }
  step++;
  if(step<6){ 
    setTimeout(breathe, 500); 
  } else {
    await speak((language==="en")?"‚ú® Well done!":"‚ú® ‡§¨‡§π‡•Å‡§§ ‡§Ö‡§ö‡•ç‡§õ‡§æ!");
    addBack();
  }
}

  breathe();
}
function detectBullying(){
  setMascotMood("bulb_thinking");
  state.awaitingBullyingDetect = true;
  
  addMessage("bot",(language==="en")
    ? "üìù Please describe the situation. I‚Äôll try to tell you if it looks like bullying."
    : "üìù ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡§æ ‡§µ‡§∞‡•ç‡§£‡§® ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Æ‡•à‡§Ç ‡§¨‡§§‡§æ‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•Ç‡§Å‡§ó‡§æ ‡§ï‡§ø ‡§Ø‡§π ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§π‡•à ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç‡•§");

  addBack();
}
function askLocation(){
  setMascotMood("bulb_thinking");
  addMessage("bot",(language==="en")
    ? "üìç Trying to detect your location‚Ä¶ please allow location access in your browser."
    : "üìç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§§‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å‚Ä¶ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç‡•§");

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const lat=pos.coords.latitude.toFixed(4);
        const lon=pos.coords.longitude.toFixed(4);
        const mapLink=`https://www.google.com/maps?q=${lat},${lon}`;

        addMessage("bot",(language==="en")
          ? `‚úÖ Location detected: ${lat}, ${lon}<br><a href="${mapLink}" target="_blank">Open in Maps</a>`
          : `‚úÖ ‡§∏‡•ç‡§•‡§æ‡§® ‡§Æ‡§ø‡§≤‡§æ: ${lat}, ${lon}<br><a href="${mapLink}" target="_blank">‡§Æ‡§æ‡§®‡§ö‡§ø‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§≤‡•á‡§Ç</a>`);

        addMessage("bot",(language==="en")
          ? `üö® Share this with police/parents. Quick Call: <a href="tel:112">112</a>`
          : `üö® ‡§™‡•Å‡§≤‡§ø‡§∏/‡§Æ‡§æ‡§§‡§æ-‡§™‡§ø‡§§‡§æ ‡§∏‡•á ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§ï‡•â‡§≤: <a href="tel:112">112</a>`);
      },
      ()=>addMessage("bot",(language==="en")
        ? "‚ö†Ô∏è Location access denied."
        : "‚ö†Ô∏è ‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡•Ä ‡§ó‡§à‡•§")
    );
  } else {
    addMessage("bot",(language==="en")
      ? "‚ùå Your browser does not support location."
      : "‚ùå ‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡•ç‡§•‡§æ‡§® ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ‡•§");
  }
  addBack();
}
function reportForm(){
  setMascotMood("bulb_serious");
  addMessage("bot",(language==="en")
    ? "üìù Fill this quick form to create a report you can share with a teacher/parent."
    : "üìù ‡§á‡§∏ ‡§õ‡•ã‡§ü‡•á ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ï‡•ã ‡§≠‡§∞‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§Ü‡§™ ‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï/‡§Æ‡§æ‡§§‡§æ-‡§™‡§ø‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¨‡§®‡§æ ‡§∏‡§ï‡•á‡§Ç‡•§");

  const formDiv=document.createElement("div");
  formDiv.className="temp-ui";

  formDiv.innerHTML=`
    <input type="text" id="who" placeholder="${language==="en"?"Who bullied you?":"‡§ï‡§ø‡§∏‡§®‡•á ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§ï‡•Ä?"}" style="width:100%;margin:5px 0;padding:6px;">
    <input type="text" id="where" placeholder="${language==="en"?"Where did it happen?":"‡§Ø‡§π ‡§ï‡§π‡§æ‡§Å ‡§π‡•Å‡§Ü?"}" style="width:100%;margin:5px 0;padding:6px;">
    <textarea id="what" placeholder="${language==="en"?"Describe what happened":"‡§ï‡•ç‡§Ø‡§æ ‡§π‡•Å‡§Ü ‡§¨‡§§‡§æ‡§á‡§è"}" style="width:100%;height:80px;margin:5px 0;padding:6px;"></textarea>
    <button class="btn" id="submitReport">${language==="en"?"üì§ Generate Report":"üì§ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Å"}</button>
  `;
  chat.appendChild(formDiv);

  document.getElementById("submitReport").onclick=()=>{
    const who=document.getElementById("who").value.trim();
    const where=document.getElementById("where").value.trim();
    const what=document.getElementById("what").value.trim();

    if(!who||!where||!what){
      addMessage("bot",(language==="en")?"‚ö†Ô∏è Please fill all fields.":"‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç‡•§");
      return;
    }

    const reportText=(language==="en")
      ? `üìã Bullying Report:\nWho: ${who}\nWhere: ${where}\nWhat: ${what}`
      : `üìã ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü:\n‡§ï‡•å‡§®: ${who}\n‡§ï‡§π‡§æ‡§Å: ${where}\n‡§ï‡•ç‡§Ø‡§æ ‡§π‡•Å‡§Ü: ${what}`;

    addMessage("bot",reportText.replace(/\n/g,"<br>"));

    // allow download
    let blob=new Blob([reportText],{type:"text/plain"});
    let link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="Bullying_Report.txt";
    link.textContent=(language==="en")?"‚¨áÔ∏è Download Report":"‚¨áÔ∏è ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç";
    chat.appendChild(link);
    autoScroll();
  };

  addBack();
}

function addBack(){
  const b=document.createElement("button");
  b.className="back-btn";
  b.textContent=texts[language].back;
  b.onclick=(e)=>{ e.preventDefault();

    // reset bullying state on back
    state.awaitingBullyingCategory=false;
    state.awaitingBullyingType=false;
    state.bullyingPersona=null;
    chat.querySelectorAll(".temp-ui").forEach(x=>x.remove());
    showMenu(); setMascotMood("bulb_default");
  };
  chat.appendChild(b);
}

/* ----------------- Sections: Bullying flow, Advice, Report, Roleplay ----------------- */
function explainBullying(){
  setMascotMood("bulb_serious");
  addMessage("bot",texts[language].bullying);
  addImage("bullying.jpeg");
  // start category question
  state.awaitingBullyingCategory=true;
  state.awaitingBullyingType=false;
  state.bullyingPersona=null;
  const q = (language==="en")
    ? "Are you a <b>child</b>, <b>adult</b>, or <b>old man</b>? Type your choice or tap a button:"
    : "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ <b>‡§¨‡§ö‡•ç‡§ö‡•á</b>, <b>‡§µ‡§Ø‡§∏‡•ç‡§ï</b> ‡§Ø‡§æ <b>‡§¨‡•Å‡§ú‡§º‡•Å‡§∞‡•ç‡§ó</b> ‡§π‡•à‡§Ç? ‡§Ö‡§™‡§®‡§æ ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Å:";
  addMessage("bot","üëÄ "+q);
  addChoiceButtons((language==="en"?["Child","Adult","Old man"]:["‡§¨‡§ö‡•ç‡§ö‡§æ","‡§µ‡§Ø‡§∏‡•ç‡§ï","‡§¨‡•Å‡§ú‡§º‡•Å‡§∞‡•ç‡§ó"]),(label)=>{ handleBullyingCategoryInput(label); });
  addBack();
}
function giveAdvice(){ setMascotMood("bulb_happy"); addMessage("bot",texts[language].advice); addImage("advice.jpeg"); addBack(); }
function reportBullying(){ setMascotMood("bulb_serious"); addMessage("bot",texts[language].report); addImage("report.jpeg"); addBack(); }
function startRoleplay(){ setMascotMood("bulb_thinking"); state.awaitingRoleplay=true; addMessage("bot",texts[language].role); addImage("roleplay.jpeg"); addBack(); }
function handleRoleplayResponse(text){
  const safe=(language==="en")
    ? /(stop|leave|respect|not okay|teacher|report|block)/i.test(text)
    : /(‡§∞‡•Å‡§ï|‡§õ‡•ã‡§°‡§º|‡§∏‡§Æ‡•ç‡§Æ‡§æ‡§®|‡§†‡•Ä‡§ï ‡§®‡§π‡•Ä‡§Ç|‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï|‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü|‡§¨‡•ç‡§≤‡•â‡§ï)/i.test(text);
  if(safe){ setMascotMood("bulb_happy"); addMessage("bot",(language==="en")?"‚≠ê Great response!":"‚≠ê ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§ú‡§µ‡§æ‡§¨!"); }
  else { setMascotMood("bulb_serious"); addMessage("bot",(language==="en")?"üí° Try: 'I want this to stop.'":"üí° ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç: '‡§Æ‡•à‡§Ç ‡§ö‡§æ‡§π‡§§‡§æ ‡§π‡•Ç‡§Å ‡§Ø‡§π ‡§∞‡•Å‡§ï‡•á‡•§'"); }
  state.awaitingRoleplay=false; addBack();
}

/* ----------------- Quiz ----------------- */
const quizQuestions = {
  en:[
    {q:"Which of these is bullying?",options:["Teasing once","Helping a friend","Repeatedly making fun of someone"],answer:2},
    {q:"What should you do if you see bullying?",options:["Ignore it","Support the target and report it","Join in"],answer:1},
    {q:"Online bullying is also called?",options:["Cyberbullying","Play fight","Prank"],answer:0}
  ],
  hi:[
    {q:"‡§á‡§®‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•å‡§® ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§π‡•à?",options:["‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§ö‡§ø‡§¢‡§º‡§æ‡§®‡§æ","‡§Æ‡§ø‡§§‡•ç‡§∞ ‡§ï‡•Ä ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡§®‡§æ","‡§¨‡§æ‡§∞-‡§¨‡§æ‡§∞ ‡§Æ‡§ú‡§æ‡§ï ‡§â‡§°‡§º‡§æ‡§®‡§æ"],answer:2},
    {q:"‡§Ö‡§ó‡§∞ ‡§Ü‡§™ ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§¶‡•á‡§ñ‡•á‡§Ç ‡§§‡•ã ‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§∞‡•á‡§Ç?",options:["‡§Ö‡§®‡§¶‡•á‡§ñ‡§æ ‡§ï‡§∞‡•á‡§Ç","‡§™‡•Ä‡§°‡§º‡§ø‡§§ ‡§ï‡§æ ‡§∏‡§æ‡§• ‡§¶‡•á‡§Ç ‡§î‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç","‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã ‡§ú‡§æ‡§è‡§Å"],answer:1},
    {q:"‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§ï‡•ã ‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§π‡§§‡•á ‡§π‡•à‡§Ç?",options:["‡§∏‡§æ‡§á‡§¨‡§∞‡§¨‡•Å‡§≤‡§ø‡§Ç‡§ó","‡§ñ‡•á‡§≤ ‡§ù‡§ó‡§°‡§º‡§æ","‡§Æ‡§ú‡§æ‡§ï"],answer:0}
  ]
};
function startQuiz(){
  setMascotMood("bulb_thinking");
  state.awaitingQuiz=true; state.quizIndex=0; state.quizScore=0;
  addMessage("bot",texts[language].quizIntro); addImage("quiz.jpeg");
  showQuizQuestion(); addBack();
}
function showQuizQuestion(){
  setMascotMood("bulb_thinking");
  const q = quizQuestions[language][state.quizIndex];
  addMessage("bot",`Q${state.quizIndex+1}: ${q.q}`);
  const opts=document.createElement("div"); opts.className="quiz-options temp-ui";
  q.options.forEach((opt,i)=>{
    const btn=document.createElement("button"); btn.className="btn"; btn.textContent=(i+1)+". "+opt;
    btn.onclick=()=>handleQuizAnswer(btn,i); opts.appendChild(btn);
  });
  chat.appendChild(opts); autoScroll();
}
function handleQuizAnswer(btn,choice){
  const q=quizQuestions[language][state.quizIndex];
  btn.parentNode.querySelectorAll("button").forEach(b=>b.disabled=true);
  if(choice===q.answer){
    setMascotMood("bulb_happy"); addMessage("bot",(language==="en")?"‚úÖ Correct!":"‚úÖ ‡§∏‡§π‡•Ä ‡§ú‡§µ‡§æ‡§¨!"); playClap(); btn.style.background="#22c55e"; state.quizScore++;
  } else {
    setMascotMood("bulb_serious");
    addMessage("bot",(language==="en")?"‚ùå Wrong. Correct: "+q.options[q.answer]:"‚ùå ‡§ó‡§≤‡§§‡•§ ‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞: "+q.options[q.answer]);
    btn.style.background="#ef4444";
  }
  state.quizIndex++;
  chat.querySelectorAll(".temp-ui").forEach(x=>x.remove());
  if(state.quizIndex<quizQuestions[language].length){ setTimeout(showQuizQuestion,800); }
  else {
    setMascotMood("bulb_cheer");
    addMessage("bot",(language==="en")
      ? `üéâ Quiz finished! Score: ${state.quizScore}/${quizQuestions[language].length}`
      : `üéâ ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§! ‡§∏‡•ç‡§ï‡•ã‡§∞: ${state.quizScore}/${quizQuestions[language].length}`);
    state.awaitingQuiz=false;
  }
}

/* ----------------- Pledge ----------------- */
function pledge(){
  setMascotMood("bulb_cheer");
  state.awaitingPledge=true;
  const pledgeText=texts[language].pledge;
  const pledgeDiv=document.createElement("div");
  pledgeDiv.className="pledge-text";
  pledgeText.split(" ").forEach((w,i)=>{
    const span=document.createElement("span");
    span.textContent=w+" "; span.id="pledgeWord"+i; pledgeDiv.appendChild(span);
  });
  chat.appendChild(pledgeDiv);
  addImage("pledge.jpeg");
  addMessage("bot",(language==="en")?"üíñ Repeat after me:":"üíñ ‡§Æ‡•á‡§∞‡•á ‡§¨‡§æ‡§¶ ‡§¨‡•ã‡§≤‡•ã:");
  const utter=new SpeechSynthesisUtterance(pledgeText);
  utter.lang=(language==="en")?"en-US":"hi-IN";
  let i=0; const words=pledgeText.split(" ");
  utter.onboundary=()=>{ if(i<words.length){
    document.querySelectorAll(".pledge-text span").forEach(s=>s.classList.remove("active"));
    const cur=document.getElementById("pledgeWord"+i); if(cur) cur.classList.add("active"); i++; } };
  speechSynthesis.speak(utter);
  addBack();
}
function handlePledgeResponse(text){
  if(language==="en"){
    if(text.toLowerCase().includes("i pledge") && text.toLowerCase().includes("bullying")){
      setMascotMood("bulb_wave"); addMessage("bot","üåü Wonderful! You spoke the pledge with courage."); playClap(); state.awaitingPledge=false;
    } else { addMessage("bot","‚ö†Ô∏è Please try again and say the pledge clearly."); }
  } else {
    if(text.includes("‡§Æ‡•à‡§Ç") && text.includes("‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä")){
      setMascotMood("bulb_wave"); addMessage("bot","üåü ‡§∂‡§æ‡§®‡§¶‡§æ‡§∞! ‡§Ü‡§™‡§®‡•á ‡§∂‡§™‡§• ‡§≤‡•Ä‡•§"); state.awaitingPledge=false;
    } else { addMessage("bot","‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∂‡§™‡§• ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¨‡•ã‡§≤‡•á‡§Ç‡•§"); }
  }
}

/* ----------------- Search fallback ----------------- */
async function searchAndAnswer(query){
  try {
    addMessage("bot","üîé Let me check that for you...");
    const url="https://api.duckduckgo.com/?q="+encodeURIComponent(query)+"&format=json";
    const res=await fetch(url);
    const data=await res.json();
    let answer=data.AbstractText || data.Heading || "Sorry, I couldn't find anything clear.";
    addMessage("bot",answer);
  } catch (e){ addMessage("bot","‚ö†Ô∏è Error fetching answer."); }
}

/* ----------------- Bullying helpers ----------------- */
function handleBullyingCategoryInput(text){
  const t=text.toLowerCase();
  chat.querySelectorAll(".temp-ui").forEach(x=>x.remove());
  if(/child/.test(t) || (language==="hi" && /‡§¨‡§ö‡•ç‡§ö‡§æ|‡§¨‡§ö‡•ç‡§ö‡•á/.test(t))){ state.bullyingPersona="child"; }
  else if(/adult/.test(t) || (language==="hi" && /‡§µ‡§Ø‡§∏‡•ç‡§ï/.test(t))){ state.bullyingPersona="adult"; }
  else if(/old/.test(t) || (language==="hi" && /‡§¨‡•Å‡§ú‡§º‡•Å‡§∞‡•ç‡§ó|‡§¨‡•Å‡§ú‡•Å‡§∞‡•ç‡§ó/.test(t))){ state.bullyingPersona="old"; }
  else {
    addMessage("bot", (language==="en") ? "‚ö†Ô∏è Please type <b>child</b>, <b>adult</b>, or <b>old man</b>." : "‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ <b>‡§¨‡§ö‡•ç‡§ö‡§æ</b>, <b>‡§µ‡§Ø‡§∏‡•ç‡§ï</b> ‡§Ø‡§æ <b>‡§¨‡•Å‡§ú‡§º‡•Å‡§∞‡•ç‡§ó</b> ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§");
    addChoiceButtons((language==="en" ? ["Child","Adult","Old man"] : ["‡§¨‡§ö‡•ç‡§ö‡§æ","‡§µ‡§Ø‡§∏‡•ç‡§ï","‡§¨‡•Å‡§ú‡§º‡•Å‡§∞‡•ç‡§ó"]),(label)=>handleBullyingCategoryInput(label));
    return;
  }

  state.awaitingBullyingCategory=false;
  state.awaitingBullyingType=true;

  let prompt="", options=[];
  if(language==="en"){
    if(state.bullyingPersona==="child"){ prompt="What kind of bullying? (physical / verbal / cyber)"; options=["Physical","Verbal","Cyber"]; }
    if(state.bullyingPersona==="adult"){ prompt="What kind of bullying? (workplace / social / online)"; options=["Workplace","Social","Online"]; }
    if(state.bullyingPersona==="old"){ prompt="What kind of bullying? (neglect / disrespect / financial)"; options=["Neglect","Disrespect","Financial"]; }
  } else {
    if(state.bullyingPersona==="child"){ prompt="‡§ï‡§ø‡§∏ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡•Ä ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä? (‡§∂‡§æ‡§∞‡•Ä‡§∞‡§ø‡§ï / ‡§Æ‡•å‡§ñ‡§ø‡§ï / ‡§ë‡§®‡§≤‡§æ‡§á‡§®)"; options=["‡§∂‡§æ‡§∞‡•Ä‡§∞‡§ø‡§ï","‡§Æ‡•å‡§ñ‡§ø‡§ï","‡§ë‡§®‡§≤‡§æ‡§á‡§®"]; }
    if(state.bullyingPersona==="adult"){ prompt="‡§ï‡§ø‡§∏ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡•Ä ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä? (‡§ï‡§æ‡§∞‡•ç‡§Ø‡§∏‡•ç‡§•‡§≤ / ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï / ‡§ë‡§®‡§≤‡§æ‡§á‡§®)"; options=["‡§ï‡§æ‡§∞‡•ç‡§Ø‡§∏‡•ç‡§•‡§≤","‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï","‡§ë‡§®‡§≤‡§æ‡§á‡§®"]; }
    if(state.bullyingPersona==="old"){ prompt="‡§ï‡§ø‡§∏ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•ç‡§µ‡•ç‡§Ø‡§µ‡§π‡§æ‡§∞? (‡§â‡§™‡•á‡§ï‡•ç‡§∑‡§æ / ‡§Ö‡§∏‡§Æ‡•ç‡§Æ‡§æ‡§® / ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï)"; options=["‡§â‡§™‡•á‡§ï‡•ç‡§∑‡§æ","‡§Ö‡§∏‡§Æ‡•ç‡§Æ‡§æ‡§®","‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï"]; }
  }
  setMascotMood("bulb_thinking");
  addMessage("bot","üí≠ "+prompt);
  addChoiceButtons(options,(label)=>handleBullyingTypeInput(label));
}
function handleBullyingTypeInput(text){
  const t=text.toLowerCase();
  chat.querySelectorAll(".temp-ui").forEach(x=>x.remove());
  let reply="";
  if(language==="en"){
    if(state.bullyingPersona==="child"){
      if(/physical/.test(t)) reply="üèÉ Tell a teacher or parent immediately. Stay with friends for safety.";
      else if(/verbal/.test(t)) reply="üó£Ô∏è Stay calm, use a firm voice, and report to a trusted adult.";
      else if(/cyber/.test(t)) reply="üíª Block/report the bully online and show messages to a guardian.";
    } else if(state.bullyingPersona==="adult"){
      if(/workplace/.test(t)) reply="üíº Document incidents, talk to HR/management, and seek formal support.";
      else if(/social/.test(t)) reply="üë• Set boundaries, lean on supportive friends/family, consider mediation.";
      else if(/online/.test(t)) reply="üåê Block/report abuse, secure accounts, consider legal/cybercrime help.";
    } else if(state.bullyingPersona==="old"){
      if(/neglect/.test(t)) reply="ü§ù Contact social services/NGOs or a trusted neighbor for immediate support.";
      else if(/disrespect/.test(t)) reply="üí¨ Share concerns with family/community leaders; ask for respect and safety.";
      else if(/financial/.test(t)) reply="üí∞ Protect assets; consult a lawyer or helpline about financial exploitation.";
    }
  } else {
    if(state.bullyingPersona==="child"){
      if(/‡§∂‡§æ‡§∞‡•Ä‡§∞‡§ø‡§ï/.test(t)) reply="üèÉ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï/‡§Æ‡§æ‡§§‡§æ-‡§™‡§ø‡§§‡§æ ‡§ï‡•ã ‡§¨‡§§‡§æ‡§è‡§Ç‡•§ ‡§¶‡•ã‡§∏‡•ç‡§§‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∞‡§π‡•á‡§Ç‡•§";
      else if(/‡§Æ‡•å‡§ñ‡§ø‡§ï/.test(t)) reply="üó£Ô∏è ‡§∂‡§æ‡§Ç‡§§ ‡§∞‡§π‡•á‡§Ç, ‡§¶‡•É‡§¢‡§º‡§§‡§æ ‡§∏‡•á ‡§¨‡•ã‡§≤‡•á‡§Ç, ‡§î‡§∞ ‡§ï‡§ø‡§∏‡•Ä ‡§¨‡§°‡§º‡•á ‡§ï‡•ã ‡§¨‡§§‡§æ‡§è‡§Ç‡•§";
      else if(/‡§ë‡§®‡§≤‡§æ‡§á‡§®/.test(t)) reply="üíª ‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§¨‡•ç‡§≤‡•â‡§ï/‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§Ö‡§≠‡§ø‡§≠‡§æ‡§µ‡§ï ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å‡•§";
    } else if(state.bullyingPersona==="adult"){
      if(/‡§ï‡§æ‡§∞‡•ç‡§Ø‡§∏‡•ç‡§•‡§≤/.test(t)) reply="üíº ‡§ò‡§ü‡§®‡§æ‡§è‡§Å ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç, HR/‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§∏‡•á ‡§¨‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç, ‡§î‡§™‡§ö‡§æ‡§∞‡§ø‡§ï ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§≤‡•á‡§Ç‡•§";
      else if(/‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï/.test(t)) reply="üë• ‡§∏‡•Ä‡§Æ‡§æ‡§è‡§Å ‡§§‡§Ø ‡§ï‡§∞‡•á‡§Ç, ‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø ‡§Æ‡§ø‡§§‡•ç‡§∞/‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§ï‡§æ ‡§∏‡§π‡§æ‡§∞‡§æ ‡§≤‡•á‡§Ç‡•§";
      else if(/‡§ë‡§®‡§≤‡§æ‡§á‡§®/.test(t)) reply="üåê ‡§¨‡•ç‡§≤‡•â‡§ï/‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç, ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç, ‡§∏‡§æ‡§á‡§¨‡§∞ ‡§π‡•á‡§≤‡•ç‡§™‡§≤‡§æ‡§á‡§® ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§";
    } else if(state.bullyingPersona==="old"){
      if(/‡§â‡§™‡•á‡§ï‡•ç‡§∑‡§æ/.test(t)) reply="ü§ù ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§∏‡•á‡§µ‡§æ‡§ì‡§Ç/NGO ‡§Ø‡§æ ‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø ‡§™‡§°‡§º‡•ã‡§∏‡•Ä ‡§∏‡•á ‡§Æ‡§¶‡§¶ ‡§≤‡•á‡§Ç‡•§";
      else if(/‡§Ö‡§∏‡§Æ‡•ç‡§Æ‡§æ‡§®/.test(t)) reply="üí¨ ‡§™‡§∞‡§ø‡§µ‡§æ‡§∞/‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§∏‡•á ‡§¨‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç; ‡§∏‡§Æ‡•ç‡§Æ‡§æ‡§® ‡§µ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§Æ‡§æ‡§Ç‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§";
      else if(/‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï/.test(t)) reply="üí∞ ‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç; ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§∂‡•ã‡§∑‡§£ ‡§™‡§∞ ‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§∏‡§≤‡§æ‡§π ‡§≤‡•á‡§Ç‡•§";
    }
  }

  if(reply){
  setMascotMood("bulb_happy");

  // Show advice
  addMessage("bot", reply);


  // Speak thank-you AFTER a small pause
  setTimeout(()=>{
    addMessage("bot", (language==="en")
      ? "‚úÖ Thank you for sharing. You can use the Back button to return to the menu."
      : "‚úÖ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§ ‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç ‡§™‡§∞ ‡§≤‡•å‡§ü‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è Back ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Å‡•§");
  }, 2000); // 2 sec delay

  state.awaitingBullyingType=false;
  state.bullyingPersona=null;
}



}

/* ----------------- Human verification (integrated) ----------------- */
function cleanForSpeech(text) {
  // Remove emojis/symbols but keep letters/numbers
  return text.replace(/[^\p{L}\p{N}\s.,!?'"-]/gu, "").trim();
}

function generateHumanCode(){
  const code = Math.floor(1000 + Math.random() * 9000); // 4-digit
  state.secretCode = String(code);
  state.codeAttempts = 0;
  state.awaitingCode = true;
  return state.secretCode;
}
function askHumanVerification(onlyRefresh=false){
  // remove temp-ui so refresh button shows single copy
  chat.querySelectorAll(".temp-ui").forEach(x=>x.remove());
  const code = state.secretCode || generateHumanCode();
  const msg = (language === "en")
    ? `ü§ñ Before we start, please type this code to prove you are human: <b>${code}</b>`
    : `ü§ñ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ø‡§π ‡§ï‡•ã‡§° ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç: <b>${code}</b>`;
  if(!onlyRefresh) addMessage("bot", msg);
  // create a small refresh UI below message
  addChoiceButtons([(language==="en")?"Refresh code":"‡§ï‡•ã‡§° ‡§¨‡§¶‡§≤‡•á‡§Ç"],()=>{
    const newCode = generateHumanCode();
    addMessage("bot", (language==="en") ? `üîÅ New code: <b>${newCode}</b>` : `üîÅ ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§°: <b>${newCode}</b>`);
  });
}

/* ----------------- Handle user input (main) ----------------- */
function analyzeBullyingSituation(text){
  state.awaitingBullyingDetect = false;
  const lower=text.toLowerCase();
  let result="";

  // simple keyword checks
  const physical=["hit","push","kick","slap","beat"];
  const verbal=["insult","stupid","ugly","abuse","curse","mock"];
  const cyber=["online","post","comment","whatsapp","facebook","instagram","troll"];
  const power=["teacher","boss","senior","group","gang","older"];

  let detected=[];

  if(physical.some(w=>lower.includes(w))) detected.push("physical harm");
  if(verbal.some(w=>lower.includes(w))) detected.push("verbal abuse");
  if(cyber.some(w=>lower.includes(w))) detected.push("cyberbullying");
  if(power.some(w=>lower.includes(w))) detected.push("power imbalance");

  if(detected.length>0){
    result = (language==="en")
      ? `‚ö†Ô∏è This situation shows signs of bullying: ${detected.join(", ")}.`
      : `‚ö†Ô∏è ‡§á‡§∏ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§ï‡•á ‡§∏‡§Ç‡§ï‡•á‡§§ ‡§π‡•à‡§Ç: ${detected.join(", ")}.`;
  } else {
    result = (language==="en")
      ? "‚úÖ It does not strongly look like bullying, but always trust your feelings and stay safe."
      : "‚úÖ ‡§Ø‡§π ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¨‡§¶‡§Æ‡§æ‡§∂‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§≤‡§ó‡§§‡•Ä, ‡§≤‡•á‡§ï‡§ø‡§® ‡§π‡§Æ‡•á‡§∂‡§æ ‡§Ö‡§™‡§®‡•Ä ‡§≠‡§æ‡§µ‡§®‡§æ ‡§™‡§∞ ‡§≠‡§∞‡•ã‡§∏‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§π‡•á‡§Ç‡•§";
  }

  addMessage("bot",result);
  addMessage("bot",(language==="en")
    ? "üëâ You can go back to the menu for more help."
    : "üëâ ‡§Ö‡§ß‡§ø‡§ï ‡§Æ‡§¶‡§¶ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Å‡•§");
}

function handleUserInput(text){
  // 1) Human verification step (if pending)
if(state.awaitingBullyingDetect){
  analyzeBullyingSituation(text);
  return;
}
  if (state.awaitingCode) {
    const cleaned = text.trim();
    if (cleaned === String(state.secretCode)) {
      state.awaitingCode = false;
      addMessage("bot", (language==="en") ? "‚úÖ Code correct! You are verified." : "‚úÖ ‡§ï‡•ã‡§° ‡§∏‡§π‡•Ä ‡§π‡•à! ‡§Ü‡§™ ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§π‡•ã ‡§ó‡§è ‡§π‡•à‡§Ç‡•§");
      addMessage("bot", texts[language].intro);
      return;
    } else {
      state.codeAttempts = (state.codeAttempts || 0) + 1;
      if (state.codeAttempts >= state.maxCodeAttempts) {
        const newCode = generateHumanCode();
        addMessage("bot", (language==="en")
          ? `‚ö†Ô∏è Too many incorrect attempts. Here's a new code: <b>${newCode}</b>`
          : `‚ö†Ô∏è ‡§¨‡§π‡•Å‡§§ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§π‡•Å‡§è‡•§ ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§°: <b>${newCode}</b>`);
        // show refresh button too
        addChoiceButtons([(language==="en")?"Refresh code":"‡§ï‡•ã‡§° ‡§¨‡§¶‡§≤‡•á‡§Ç"],()=>{
          const nc = generateHumanCode();
          addMessage("bot", (language==="en") ? `üîÅ New code: <b>${nc}</b>` : `üîÅ ‡§®‡§Ø‡§æ ‡§ï‡•ã‡§°: <b>${nc}</b>`);
        });
      } else {
        addMessage("bot", (language==="en")
          ? `‚ö†Ô∏è Wrong code. Please type exact code:`
          : `‚ö†Ô∏è ‡§ó‡§≤‡§§ ‡§ï‡•ã‡§°‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§†‡•Ä‡§ï ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç:`);
      }
      return;
    }
  }

  // 2) Normal bot flows below
  if(state.awaitingName){
    state.awaitingName=false;
    state.userName=text;
    addMessage("bot",`${texts[language].nice} <b>${state.userName}</b>!`);
    showMenu();
    return;
  }
  if(state.awaitingBullyingCategory){ handleBullyingCategoryInput(text); return; }
  if(state.awaitingBullyingType){ handleBullyingTypeInput(text); return; }
  if(state.awaitingRoleplay){ handleRoleplayResponse(text); return; }
  if(state.awaitingPledge){ handlePledgeResponse(text); return; }
  if(state.awaitingQuiz){ return; } // quiz uses buttons; ignore text during quiz
  // fallback search
  searchAndAnswer(text);
}

/* ----------------- Form submit ----------------- */
document.getElementById("composer").addEventListener("submit",e=>{
  e.preventDefault();
  const text=document.getElementById("input").value.trim();
  if(!text) return;
  addMessage("user",text);
  document.getElementById("input").value="";
  handleUserInput(text);
});

/* ----------------- Mascot vertical bounce ----------------- */
let dy = 2;
function bounceMascotVertical() {
  const app = document.querySelector(".app");
  const mascotHeight = mascot.clientHeight || 180;
  let y = parseInt(mascot.style.top || "150");
  y += dy;
  const x = app.clientWidth - mascot.clientWidth - 20;
  mascot.style.left = x + "px";
  const minY = 120;
  const maxY = app.clientHeight - mascotHeight - 20;
  if (y <= minY || y >= maxY) { dy = -dy; }
  mascot.style.top = y + "px";
  requestAnimationFrame(bounceMascotVertical);
}
window.onload = () => {
  const app = document.querySelector(".app");
  const x = app.clientWidth - mascot.clientWidth - 20;
  mascot.style.left = x + "px";
  mascot.style.top = "150px";
  bounceMascotVertical();
  // start human verification prompt
  askHumanVerification();
};

/* ----------------- Angry reaction ----------------- */
function angrySpeak(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 1;
  utterance.pitch = 0.6;
  utterance.volume = 1;
  speechSynthesis.speak(utterance);
}
function playSiren() {
  const siren = new Audio("siren.mp3");
  siren.play();
  setTimeout(() => {
    siren.pause();
    siren.currentTime = 0;
  }, 5000);
}
document.getElementById("mascot").addEventListener("click", () => {
  const m = document.getElementById("mascot");
  m.classList.add("angry");
  angrySpeak((language==="en")?"Stay away!":"‡§¶‡•Ç‡§∞ ‡§∞‡§π‡•á‡§Ç!");
  playSiren();
  setTimeout(()=>{ m.classList.remove("angry"); }, 5000);
});
// üéôÔ∏è Voice input
let recognition;
if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    addMessage("user", transcript);     // show what user said
    handleUserInput(transcript);        // process as normal input
  };

  recognition.onerror = (event) => {
    addMessage("bot", (language==="en") 
      ? "‚ö†Ô∏è I couldn't hear you properly. Please try again." 
      : "‚ö†Ô∏è ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•ã ‡§†‡•Ä‡§ï ‡§∏‡•á ‡§∏‡•Å‡§® ‡§®‡§π‡•Ä‡§Ç ‡§™‡§æ‡§Ø‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§ø‡§∞ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§");
  };
}

</script>
</body>
</html>
